<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <title>coreAnimation | Mou</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.0.3">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    
    <link rel="next" href="../cocoapods/README.html" />
    
    
    <link rel="prev" href="../uidynamic/README.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book"  data-level="26" data-basepath=".." data-revision="1462863912916">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         Markdown语法
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="base/README.html">
            
                
                    <a href="../base/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         base
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="uiview/README.html">
            
                
                    <a href="../uiview/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         UIView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="jiugongge/README.html">
            
                
                    <a href="../jiugongge/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         jiugongge
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4" data-path="uiscrollview/README.html">
            
                
                    <a href="../uiscrollview/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                         UIScrollView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5" data-path="uitableview/README.html">
            
                
                    <a href="../uitableview/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                         UITableView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="6" data-path="autolayout/README.html">
            
                
                    <a href="../autolayout/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                         autolayout
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="7" data-path="map/README.html">
            
                
                    <a href="../map/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                         map
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="8" data-path="notification/README.html">
            
                
                    <a href="../notification/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                         notification
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="9" data-path="nstimer/README.html">
            
                
                    <a href="../nstimer/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                         nstimer
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="10" data-path="oc/README.html">
            
                
                    <a href="../oc/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                         OC
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="11" data-path="rac/README.html">
            
                
                    <a href="../rac/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                         rac
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="12" data-path="review1/README.html">
            
                
                    <a href="../review1/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>12.</b>
                        
                         review1
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="13" data-path="review2/README.html">
            
                
                    <a href="../review2/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.</b>
                        
                         review2
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="14" data-path="audio/README.html">
            
                
                    <a href="../audio/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>14.</b>
                        
                         audio
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="15" data-path="twocode/README.html">
            
                
                    <a href="../twocode/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>15.</b>
                        
                         twocode
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="16" data-path="memory/README.html">
            
                
                    <a href="../memory/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>16.</b>
                        
                         memory
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="17" data-path="bluetooth/README.html">
            
                
                    <a href="../bluetooth/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>17.</b>
                        
                         bluetooth
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="18" data-path="touchid/README.html">
            
                
                    <a href="../touchid/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>18.</b>
                        
                         touchid
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="19" data-path="uiviewcontroller/README.html">
            
                
                    <a href="../uiviewcontroller/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>19.</b>
                        
                         UIViewController
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="20" data-path="delegate_kvo/README.html">
            
                
                    <a href="../delegate_kvo/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>20.</b>
                        
                         delegate kvo
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="21" data-path="datasave/README.html">
            
                
                    <a href="../datasave/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>21.</b>
                        
                         dataSave
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="22" data-path="pickerview/README.html">
            
                
                    <a href="../pickerview/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>22.</b>
                        
                         pickerView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="23" data-path="quartz2d/README.html">
            
                
                    <a href="../quartz2d/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>23.</b>
                        
                         quartz2D
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="24" data-path="uitextfield/README.html">
            
                
                    <a href="../uitextfield/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>24.</b>
                        
                         UITextField
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="25" data-path="uidynamic/README.html">
            
                
                    <a href="../uidynamic/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>25.</b>
                        
                         UIDynamic
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="26" data-path="coreanimation/README.html">
            
                
                    <a href="../coreanimation/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>26.</b>
                        
                         coreAnimation
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="27" data-path="cocoapods/README.html">
            
                
                    <a href="../cocoapods/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>27.</b>
                        
                         Cocoapods
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="28" data-path="thread/README.html">
            
                
                    <a href="../thread/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>28.</b>
                        
                         Thread
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="29" data-path="network/README.html">
            
                
                    <a href="../network/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>29.</b>
                        
                         network
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >Mou</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_15">
                    
                        <h1 id="coreanimation">coreAnimation</h1>
<p>注意：核心动画一切都是假象，并不会真实的改变图层的属性值，如果以后做动画的时候，不需要与用户交互，通常用核心动画（转场）。
UIView动画必须通过修改属性的真实值，才有动画效果。</p>
<h1 id="">图片折叠效果</h1>
<h3 id="1">1.如何制作图片折叠效果？</h3>
<p><code>把一张图片分成两部分显示，上面一部分，下面一部分，折叠上面部分的内容。</code>
<img src="images/Snip20150619_0.png" alt=""></p>
<h3 id="2">2.如何把一张图片分成两部分显示。</h3>
<p>搞两个控件，一个显示上半部分，一个显示下半部分，需要用到Layer(图层)的一个属性<code>contentsRect</code>,这个属性是可以控制图片显示的尺寸，可以让图片只显示上部分或者下部分，注意:<code>取值范围是0~1</code>.</p>
<p>CGRectMake(0, 0, 1, 0.5)   : <code>表示显示上半部分</code></p>
<p>CGRectMake(0, 0.5, 1, 0.5) : <code>表示显示下半部分</code>
<img src="images/Snip20150618_1.png" alt=""></p>
<h3 id="3">3.如何快速的把两部分拼接成一张完整的图片。</h3>
<p>3.1 首先了解折叠，折叠其实就是旋转，既然需要旋转就需要明确锚点，因为默认都是绕着锚点旋转的。</p>
<p>3.2 上部分内容绕着底部中心旋转，所以设置上部分的锚点为（0.5，1）</p>
<p>3.3 锚点设置好了，就可以确定位置了.</p>
<p>3.4 可以把上下部分重合在一起，然后分别设置上下部分的锚点，
上部分的锚点为<code>（0.5，1）</code>，下部分的锚点为<code>（0.5，0）</code>,就能快速重叠了。</p>
<p><img src="images/Snip20150619_2.png" alt=""></p>
<h3 id="4">4.如何折叠上部分内容。</h3>
<p>在拖动视图的时候，旋转上部分控件。修改<code>transform</code>属性。</p>
<ul>
<li>可以在上部分和下部分底部添加一个拖动控件（<code>拖动控件尺寸就是完整的图片尺寸</code>），给这个控件添加一个pan手势，就能制造一个假象，拖动控件的时候，折叠图片。</li>
<li>计算Y轴每偏移一点，需要旋转多少角度，假设完整图片尺寸高度为200，当y = 200时，上部分图片应该刚好旋转180°，因此<code>angle = offsetY  * M_PI / 200</code>;</li>
<li>上部分内容应该是绕着X轴旋转，<code>逆时针旋转</code>，因此角度需要为负数。
```objc</li>
<li><p>(void)awakeFromNib
{
  _topImgView.layer.contentsRect = CGRectMake(0, 0, 1, 0.5);
  _topImgView.layer.anchorPoint = CGPointMake(0.5, 1);</p>
<p>  _bottomImgView.layer.contentsRect = CGRectMake(0, 0.5, 1, 0.5);
  _bottomImgView.layer.anchorPoint = CGPointMake(0.5, 0);</p>
<p>  // 渐变图层
  CAGradientLayer *gradientLayer = [CAGradientLayer layer];
  // 图层设置尺寸
  gradientLayer.frame = self.bottomImgView.bounds;
  gradientLayer.opacity = 0;
  gradientLayer.colors = @[(id)[UIColor clearColor].CGColor,(id)[UIColor blackColor].CGColor];
  _gradientLayer = gradientLayer;
  [self.bottomImgView.layer addSublayer:gradientLayer];
}</p>
</li>
<li><p>(IBAction)pan:(UIPanGestureRecognizer<em>)pan
{
   // 获取偏移量
  CGPoint point = [pan translationInView:self];
  // 计算折叠角度，因为需要逆时针旋转，所以取反
  CGFloat angle = -point.y / 200 </em> M_PI;
  // 初始化形变
  CATransform3D transform = CATransform3DIdentity;</p>
<p>  // 增加旋转的立体感，近大远小,d：距离图层的距离,设置M34就有立体感(近大远小)。 -1 / z,z表示观察者在z轴上的值,z越小，看起来离我们越近，东西越大
  transform.m34 = -1 / 500.0;
  transform = CATransform3DRotate(transform, angle, 1, 0, 0);
  self.topImgView.layer.transform = transform;</p>
<p>  self.gradientLayer.opacity = point.y * 1 / 200.0;
  if (pan.state == UIGestureRecognizerStateEnded) {</p>
<pre><code>  // 反弹 当手指抬起的时候，应该把折叠图片还原，其实就是把形变清空。
  [UIView animateWithDuration:0.6 delay:0 usingSpringWithDamping:0.2 initialSpringVelocity:10 options:UIViewAnimationOptionCurveEaseInOut animations:^{
      self.topImgView.layer.transform = CATransform3DIdentity;
  } completion:^(BOOL finished) {
  }];
</code></pre><p>  }
}
```</p>
</li>
</ul>
<h3 id="">阴影效果</h3>
<p>当折叠图片的时候，底部应该有个阴影渐变过程。</p>
<ul>
<li>利用<code>CAGradientLayer</code>（渐变图层）制作阴影效果，添加到底部视图上，并且一开始需要隐藏，在拖动的时候慢慢显示出来。</li>
<li>颜色应是由<code>透明到黑色</code>渐变,表示阴影从无到有。</li>
</ul>
<pre><code class="lang-objc"><span class="hljs-comment">// 创建渐变图层</span>
CAGradientLayer *shadomLayer = [CAGradientLayer layer];

<span class="hljs-comment">// 设置渐变颜色</span>
    shadomLayer<span class="hljs-variable">.colors</span> = @[(<span class="hljs-keyword">id</span>)[<span class="hljs-built_in">UIColor</span> clearColor],(<span class="hljs-keyword">id</span>)[[<span class="hljs-built_in">UIColor</span> blackColor] CGColor]];

    shadomLayer<span class="hljs-variable">.frame</span> = _bottomView<span class="hljs-variable">.bounds</span>;

    _shadomLayer = shadomLayer;

<span class="hljs-comment">// 设置不透明度 0</span>
    shadomLayer<span class="hljs-variable">.opacity</span> = <span class="hljs-number">0</span>;

    [_bottomView<span class="hljs-variable">.layer</span> addSublayer:shadomLayer];
</code></pre>
<ul>
<li>在拖动的时候计算不透明度值，假设拖动200，阴影完全显示，不透明度应该为1，因此 opacity = y轴偏移量 * 1 /  200.0;</li>
</ul>
<pre><code class="lang-objc">
<span class="hljs-comment">// 设置阴影不透明度</span>
    _shadomLayer<span class="hljs-variable">.opacity</span> = transP<span class="hljs-variable">.y</span> * <span class="hljs-number">1</span> /  <span class="hljs-number">200.0</span>;
</code></pre>
<ul>
<li>在手指抬起的时候，需要把阴影设置隐藏，不透明度为0；</li>
</ul>
<pre><code class="lang-objc"> <span class="hljs-keyword">if</span> (sender<span class="hljs-variable">.state</span> == UIGestureRecognizerStateEnded) { <span class="hljs-comment">// 手指抬起</span>
        <span class="hljs-comment">// 还原</span>
        [<span class="hljs-built_in">UIView</span> animateWithDuration:<span class="hljs-number">0.5</span> delay:<span class="hljs-number">0</span> usingSpringWithDamping:<span class="hljs-number">0.1</span> initialSpringVelocity:<span class="hljs-number">3</span> options:UIViewAnimationOptionCurveEaseInOut animations:^{

            _topView<span class="hljs-variable">.layer</span><span class="hljs-variable">.transform</span> = CATransform3DIdentity;

            <span class="hljs-comment">// 还原阴影</span>
            _shadomLayer<span class="hljs-variable">.opacity</span> = <span class="hljs-number">0</span>;


        } completion:<span class="hljs-literal">nil</span>];
    }
</code></pre>
<h1 id="">音量振动条</h1>
<h3 id="">如果实现？</h3>
<p>创建3个layer，按顺序播放y轴缩放动画</p>
<h3 id="careplicatorlayer">利用CAReplicatorLayer实现</h3>
<p>1、什么是CAReplicatorLayer？</p>
<p>一种可以复制自己子层的layer,并且复制出来的layer和原生子层有同样的属性，位置，形变，动画。</p>
<p>2、CAReplicatorLayer属性</p>
<ul>
<li><code>instanceCount</code>: 子层总数（包括原生子层）</li>
<li><code>instanceDelay</code>: 复制子层动画延迟时长</li>
<li><code>instanceTransform</code>: 复制子层形变(不包括原生子层)，每个复制子层都是相对上一个。</li>
<li><code>instanceColor</code>: 子层颜色，会和原生子层背景色冲突，因此二者选其一设置。</li>
<li><code>instanceRedOffset、instanceGreenOffset、instanceBlueOffset、instanceAlphaOffset</code>: 颜色通道偏移量，每个复制子层都是相对上一个的偏移量。</li>
</ul>
<h3 id="careplicatorlayer">如果利用CAReplicatorLayer实现</h3>
<p>1.首先创建复制layer,音乐振动条layer添加到复制layer上，然后复制子层就好了。</p>
<pre><code class="lang-objc">CAReplicatorLayer *layer = [CAReplicatorLayer layer];

    layer<span class="hljs-variable">.frame</span> = CGRectMake(<span class="hljs-number">50</span>, <span class="hljs-number">50</span>, <span class="hljs-number">200</span>, <span class="hljs-number">200</span>);

    layer<span class="hljs-variable">.backgroundColor</span> = [<span class="hljs-built_in">UIColor</span> lightGrayColor]<span class="hljs-variable">.CGColor</span>;

    [<span class="hljs-keyword">self</span><span class="hljs-variable">.view</span><span class="hljs-variable">.layer</span> addSublayer:layer];
</code></pre>
<p>2.先创建一个音量振动条，并且设置好动画,动画是绕着底部缩放，设置锚点</p>
<pre><code class="lang-objc">    CALayer *bar = [CALayer layer];

    bar<span class="hljs-variable">.backgroundColor</span> = [<span class="hljs-built_in">UIColor</span> redColor]<span class="hljs-variable">.CGColor</span>;

    bar<span class="hljs-variable">.bounds</span> = CGRectMake(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">30</span>, <span class="hljs-number">100</span>);

    bar<span class="hljs-variable">.position</span> = CGPointMake(<span class="hljs-number">15</span>, <span class="hljs-number">200</span>);

    bar<span class="hljs-variable">.anchorPoint</span> = CGPointMake(<span class="hljs-number">0.5</span>, <span class="hljs-number">1</span>);

    [layer addSublayer:bar];

    CABasicAnimation *anim = [CABasicAnimation animation];

    anim<span class="hljs-variable">.keyPath</span> = <span class="hljs-string">@"transform.scale.y"</span>;

    anim<span class="hljs-variable">.toValue</span> = @(<span class="hljs-number">0.1</span>);

    anim<span class="hljs-variable">.autoreverses</span> = <span class="hljs-literal">YES</span>;

    anim<span class="hljs-variable">.repeatCount</span> = MAXFLOAT;

    [bar addAnimation:anim forKey:<span class="hljs-literal">nil</span>];
</code></pre>
<p>3.复制子层</p>
<pre><code class="lang-objc">    <span class="hljs-comment">// 设置4个子层，3个复制层</span>
    layer<span class="hljs-variable">.instanceCount</span> = <span class="hljs-number">4</span>;

    <span class="hljs-comment">// 设置复制子层的相对位置，每个x轴相差40</span>
    layer<span class="hljs-variable">.instanceTransform</span> = CATransform3DMakeTranslation(<span class="hljs-number">40</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

    <span class="hljs-comment">// 设置复制子层的延迟动画时长</span>
    layer<span class="hljs-variable">.instanceDelay</span> = <span class="hljs-number">0.3</span>;
</code></pre>
<h1 id="03-">03-活动指示器</h1>
<h3 id="">实现思路</h3>
<p>1.创建复制图层</p>
<pre><code class="lang-objc">CAReplicatorLayer *replicator = [CAReplicatorLayer layer];
replicator<span class="hljs-variable">.frame</span> = CGRectMake(<span class="hljs-number">50</span>, <span class="hljs-number">50</span>, <span class="hljs-number">200</span>, <span class="hljs-number">200</span>);
replicator<span class="hljs-variable">.backgroundColor</span> = [<span class="hljs-built_in">UIColor</span> redColor]<span class="hljs-variable">.CGColor</span>;
[<span class="hljs-keyword">self</span><span class="hljs-variable">.view</span><span class="hljs-variable">.layer</span> addSublayer:replicator];
</code></pre>
<p>2.创建一个矩形图层，设置缩放动画。</p>
<pre><code class="lang-objc">CALayer *layer = [CALayer layer];
layer<span class="hljs-variable">.transform</span> = CATransform3DMakeScale(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
layer<span class="hljs-variable">.position</span> = CGPointMake(<span class="hljs-number">100</span>, <span class="hljs-number">20</span>);
layer<span class="hljs-variable">.bounds</span> = CGRectMake(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>);
layer<span class="hljs-variable">.backgroundColor</span> = [<span class="hljs-built_in">UIColor</span> greenColor]<span class="hljs-variable">.CGColor</span>;
[replicator addSublayer:layer];

<span class="hljs-built_in">CGFloat</span> duration = <span class="hljs-number">1</span>;
CABasicAnimation *anim = [CABasicAnimation animation];
anim<span class="hljs-variable">.keyPath</span> = <span class="hljs-string">@"transform.scale"</span>;
anim<span class="hljs-variable">.fromValue</span> = @<span class="hljs-number">1</span>;
anim<span class="hljs-variable">.toValue</span> = @<span class="hljs-number">0</span>;
anim<span class="hljs-variable">.repeatCount</span> = MAXFLOAT;
anim<span class="hljs-variable">.duration</span> = duration;
[layer addAnimation:anim forKey:<span class="hljs-literal">nil</span>];
</code></pre>
<p>3.复制矩形图层，并且设置每个复制层的角度形变</p>
<pre><code class="lang-objc"><span class="hljs-keyword">int</span> count = <span class="hljs-number">20</span>;
<span class="hljs-built_in">CGFloat</span> angle = M_PI * <span class="hljs-number">2</span> / count;
<span class="hljs-comment">// 设置子层次数</span>
replicator<span class="hljs-variable">.instanceCount</span> = count;
<span class="hljs-comment">// 设置子层形变角度</span>
replicator<span class="hljs-variable">.instanceTransform</span> = CATransform3DMakeRotation(angle, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
</code></pre>
<p>4.设置复制动画延长时间（需要保证第一个执行完毕之后，绕一圈刚好又是从第一个执行，因此需要把动画时长平均分给每个子层）
公式:延长时间 = 动画时长 / 子层总数
假设有两个图层，动画时间为1秒，延长时间就为0.5秒。当第一个动画执行到一半的时候（0.5），第二个开始执行。第二个执行完</p>
<pre><code class="lang-objc"><span class="hljs-comment">// 设置子层动画延长时间</span>
replicator<span class="hljs-variable">.instanceDelay</span> = duration / count;
</code></pre>
<h1 id="04">04.粒子动画</h1>
<p>效果：随机绘制一条路径，点击开始按钮，粒子动画</p>
<h3 id="">实现思路</h3>
<p>1.搞个画板绘制路径，自定义view</p>
<p>2.给自定义view添加pan手势，和创建复制图层和圆形图层，只需要设置一次，在awakeFromNib方法中设置。</p>
<pre><code>    // 添加pan手势
    UIPanGestureRecognizer *pan = [[UIPanGestureRecognizer alloc] initWithTarget:self action:@selector(pan:)];

    [self addGestureRecognizer:pan];

    // 创建复制图层
    CAReplicatorLayer *repLayer = [CAReplicatorLayer layer];

    repLayer.frame = self.bounds;

    [self.layer addSublayer:repLayer];


    // 创建粒子图层
    CALayer *layer = [CALayer layer];

    layer.cornerRadius = 5;

    layer.frame = CGRectMake(-100, 10, 10, 10);

    layer.backgroundColor = [UIColor whiteColor].CGColor;

    [repLayer addSublayer:layer];

    _dotLayer = layer;
</code></pre><p>3.因为核心动画只能设置一个路径，因此只能创建一个路径，懒加载路径。</p>
<pre><code>- (UIBezierPath *)path
{
    if (_path == nil) {
        _path = [UIBezierPath bezierPath];
    }

    return _path;
}
</code></pre><p>4.在一开始拖动的时候，保存路径起点，设置路径起点，拖动的时候每次添加线到某个点。</p>
<pre><code>
    CGPoint curP = [pan locationInView:self];
    if (pan.state == UIGestureRecognizerStateBegan) {

        _startP = curP;

        [self.path moveToPoint:_startP];

    }

    [self.path addLineToPoint:curP];


    [self setNeedsDisplay];
</code></pre><p>5.路径绘制好了，点击开始按钮的时候，添加动画到图层</p>
<pre><code>CAKeyframeAnimation *anim = [CAKeyframeAnimation animation];

    anim.keyPath = @&quot;position&quot;;
    anim.duration = 4;
    anim.path = self.path.CGPath;

    anim.repeatCount = MAXFLOAT;

    [_dotLayer addAnimation:anim forKey:@&quot;anim&quot;];
    anim.delegate = self;
</code></pre><p>6.复制图层</p>
<pre><code>    repLayer.instanceCount = 20;
    repLayer.instanceDelay = 4 / 20.0;

    // 设置子层颜色
    repLayer.instanceColor = [UIColor colorWithRed:0 green:1 blue:0 alpha:1].CGColor;

    // 设置子层颜色绿色通道偏移量
    repLayer.instanceGreenOffset = -0.03;
</code></pre><p>7.重绘
清空路径，重新绘制，移除图层动画。</p>
<pre><code>    _path = nil;
    [_dotLayer removeAnimationForKey:@&quot;anim&quot;];
    [self setNeedsDisplay];
</code></pre><h1 id="05-">05-倒影</h1>
<h3 id="">实现思路：</h3>
<p>1.用复制图层实现，搞个UIImageView展示图片，然后复制UIImageView.</p>
<p>2.注意：<code>复制图层只能复制子层，但是UIImageView只有一个主层，并没有子层，因此不能直接复制UIImageView</code>.</p>
<p>3.正确做法:应该把UIImageView添加到一个UIView上，然后复制UIView的层，就能复制UIImageView.</p>
<p>注意：<code>默认A控件是B控件的子控件，那么A控件的层就是B控件的层的子层。</code></p>
<p>4.但是有问题，默认UIView的层不是复制层，我们想把UIView的层变成复制层，重写+layerClass方法。</p>
<pre><code>+ (Class)layerClass
{
    return [CAReplicatorLayer class];
}
</code></pre><p>5.倒影效果：就是就是把复制图片旋转180度，然后往下平移，最好先偏移在，在旋转。</p>
<pre><code>     CAReplicatorLayer *layer = (CAReplicatorLayer *)self.v.layer;

    layer.instanceCount = 2;


    // 先Y轴偏移
    CATransform3D transform =  CATransform3DMakeTranslation(0, self.v.bounds.size.height, 0);

    // 在旋转
    transform = CATransform3DRotate(transform, M_PI, 1, 0, 0);

    // 设置复制层的形变
    layer.instanceTransform = transform;

    // 设置颜色通道偏移量，相等上一个一点偏移量，就是阴影效果
    layer.instanceRedOffset = -0.1;
    layer.instanceGreenOffset = -0.1;
    layer.instanceBlueOffset = -0.1;
    layer.instanceAlphaOffset = -0.1;
</code></pre><h1 id="06-qq">06-QQ粘性效果</h1>
<p>实现思路:</p>
<h3 id="1uibutton">1.自定义大圆控件（UIButton）可以显示背景图片，和文字</h3>
<h3 id="2">2.让大圆控件随着手指移动而移动</h3>
<ul>
<li>注意不能根据形变修改大圆的位置，只能通过center，因为全程都需要用到中心点计算。</li>
</ul>
<h3 id="3">3.在拖动的时候，添加一个小圆控件在原来大圆控件的位置</h3>
<ul>
<li>注意这个小圆控件并不会随着手指移动而移动，因此应该添加到父控件上</li>
<li>一开始设置中心点和尺寸和大圆控件一样。</li>
<li>随着大圆拖动，小圆半径不断减少，可以根据两个圆心的距离，随便生成一段比例，随着圆心距离增加，圆心半径不断减少。</li>
</ul>
<pre><code>        // 计算小圆半径：随机搞个比例，随着圆心距离增加，圆心半径不断减少。
        CGFloat smallRadius = _circleR2 - d / 10;
</code></pre><ul>
<li>每次小圆改变，需要重新设置小圆的尺寸和圆角半径。</li>
</ul>
<h3 id="4">4.粘性效果</h3>
<ul>
<li>就是在两圆之间绘制一个形变矩形，描述形变矩形路径。</li>
<li><code>这里大致介绍下计算思路，不需要太纠结</code></li>
<li>这里需要用到CAShapeLayer,可以根据一个路径，生成一个图层，展示出来。把形变图层添加到父控件并且显示在小圆图层下就OK了。因为所有计算出来的点，都是基于父控件。</li>
<li><code>注意：这里不能用绘图，因为绘图内容只要超过当前控件尺寸就不会显示，但是当前形变矩形必须显示在控件之外</code></li>
</ul>
<h3 id="5">5.粘性业务逻辑处理</h3>
<ul>
<li><p>当圆心距离超过100，就不需要描述形变矩形（并且把之前的形变矩形移除父层），小圆也需要隐藏。</p>
</li>
<li><p>没有超过100，则相反。</p>
</li>
</ul>
<h3 id="6">6.手指停止拖动业务逻辑</h3>
<ul>
<li>判断下圆心是否超过100，超过就播放爆炸效果，添加个UIImageView在当前控件上，并且需要取消控制器view的自动布局。</li>
</ul>
<pre><code>    // 取消Autoresizing转自动布局
    self.view.translatesAutoresizingMaskIntoConstraints = NO;
</code></pre><ul>
<li>没有超过，就还原。</li>
</ul>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../uidynamic/README.html" class="navigation navigation-prev " aria-label="Previous page: UIDynamic"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../cocoapods/README.html" class="navigation navigation-next " aria-label="Next page: Cocoapods"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
