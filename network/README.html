<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <title>network | Mou</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.0.3">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    
    
    <link rel="prev" href="../thread/README.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book"  data-level="29" data-basepath=".." data-revision="1462863912916">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         Markdown语法
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="base/README.html">
            
                
                    <a href="../base/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         base
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="uiview/README.html">
            
                
                    <a href="../uiview/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         UIView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="jiugongge/README.html">
            
                
                    <a href="../jiugongge/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         jiugongge
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4" data-path="uiscrollview/README.html">
            
                
                    <a href="../uiscrollview/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                         UIScrollView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5" data-path="uitableview/README.html">
            
                
                    <a href="../uitableview/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                         UITableView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="6" data-path="autolayout/README.html">
            
                
                    <a href="../autolayout/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                         autolayout
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="7" data-path="map/README.html">
            
                
                    <a href="../map/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                         map
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="8" data-path="notification/README.html">
            
                
                    <a href="../notification/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                         notification
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="9" data-path="nstimer/README.html">
            
                
                    <a href="../nstimer/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                         nstimer
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="10" data-path="oc/README.html">
            
                
                    <a href="../oc/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                         OC
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="11" data-path="rac/README.html">
            
                
                    <a href="../rac/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                         rac
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="12" data-path="review1/README.html">
            
                
                    <a href="../review1/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>12.</b>
                        
                         review1
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="13" data-path="review2/README.html">
            
                
                    <a href="../review2/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.</b>
                        
                         review2
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="14" data-path="audio/README.html">
            
                
                    <a href="../audio/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>14.</b>
                        
                         audio
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="15" data-path="twocode/README.html">
            
                
                    <a href="../twocode/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>15.</b>
                        
                         twocode
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="16" data-path="memory/README.html">
            
                
                    <a href="../memory/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>16.</b>
                        
                         memory
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="17" data-path="bluetooth/README.html">
            
                
                    <a href="../bluetooth/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>17.</b>
                        
                         bluetooth
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="18" data-path="touchid/README.html">
            
                
                    <a href="../touchid/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>18.</b>
                        
                         touchid
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="19" data-path="uiviewcontroller/README.html">
            
                
                    <a href="../uiviewcontroller/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>19.</b>
                        
                         UIViewController
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="20" data-path="delegate_kvo/README.html">
            
                
                    <a href="../delegate_kvo/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>20.</b>
                        
                         delegate kvo
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="21" data-path="datasave/README.html">
            
                
                    <a href="../datasave/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>21.</b>
                        
                         dataSave
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="22" data-path="pickerview/README.html">
            
                
                    <a href="../pickerview/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>22.</b>
                        
                         pickerView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="23" data-path="quartz2d/README.html">
            
                
                    <a href="../quartz2d/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>23.</b>
                        
                         quartz2D
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="24" data-path="uitextfield/README.html">
            
                
                    <a href="../uitextfield/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>24.</b>
                        
                         UITextField
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="25" data-path="uidynamic/README.html">
            
                
                    <a href="../uidynamic/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>25.</b>
                        
                         UIDynamic
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="26" data-path="coreanimation/README.html">
            
                
                    <a href="../coreanimation/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>26.</b>
                        
                         coreAnimation
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="27" data-path="cocoapods/README.html">
            
                
                    <a href="../cocoapods/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>27.</b>
                        
                         Cocoapods
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="28" data-path="thread/README.html">
            
                
                    <a href="../thread/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>28.</b>
                        
                         Thread
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="29" data-path="network/README.html">
            
                
                    <a href="../network/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>29.</b>
                        
                         network
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >Mou</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_22">
                    
                        <h1 id="network">network</h1>
<ul>
<li>客户端通过URL找到想要连接的服务器</li>
<li>URL:Uniform Resource Locator统一资源定位符</li>
<li>通过一个URL，能找到互联网上唯一的1个资源</li>
<li>URL就是资源的地址、位置，互联网上的每个资源都有一个唯一的URL</li>
<li><p>URL基本格式 = 协议://主机地址/路径</p>
<ul>
<li>协议：不同的协议代表不同的资源查找方式，资源传输方式</li>
<li>主机地址：存放资源的主机的ip地址(域名)</li>
<li>路径:资源在主机中的具体位置</li>
</ul>
</li>
<li><p>URL中常见的协议</p>
<ul>
<li>HTTP超文本传输协议，访问的是远程网络资源，格式是http://</li>
<li>file访问的是本地计算机上的资源，格式是file://(不用加主机地址)</li>
<li>mailto 访问的是电子邮件地址，格式是mailto:</li>
<li>FTP访问的是共享主机的文件资源，格式是ftp://</li>
</ul>
</li>
<li><p>HTTP协议的作用</p>
<ul>
<li>规定客户端和服务器之间的数据传输格式</li>
</ul>
</li>
<li>HTTP协议的特点<ul>
<li>简单快速(因HTTP协议简单所以HTTP服务器的程序规模小因而通信速度很快)</li>
<li>灵活(HTTP允许传输各种各样的数据)</li>
<li>HTTP 0.9和1.0使用非持续连接(限制每次连接只处理一个请求，服务器对客户端的请求做出响应后，马上断开连接，这种方式可以节省传输时间)</li>
</ul>
</li>
<li>完整的http通信可以分为2大步骤<ul>
<li>请求：客户端向服务器索要数据</li>
<li>响应：服务器返回客户端相应的数据</li>
</ul>
</li>
<li>发送HTTP请求的方法<ul>
<li>在HTTP/1.1协议中，定义了8种发送http请求的方法(GET、POST、OPTIONS、HEAD、PUT、DELETE、TRACE、CONNECT、PATCH)</li>
</ul>
</li>
<li>GET和POST的主要区别<ul>
<li>GET<ul>
<li>GET在请求URL后面以?的形式跟上发给服务器的参数，多个参数之间用&amp;隔开，比如<a href="http://ww.test.com/login?username=123&amp;pwd=234&amp;type=JSON(由于浏览器和服务器对URL长度有限制，因此在URL后面附带的参数是有限制的，通常不能超过1KB" target="_blank">http://ww.test.com/login?username=123&amp;pwd=234&amp;type=JSON(由于浏览器和服务器对URL长度有限制，因此在URL后面附带的参数是有限制的，通常不能超过1KB</a>)</li>
<li>没有请求体</li>
<li>一般用来查询数据</li>
</ul>
</li>
<li>POST<ul>
<li>所有参数全部放在请求体中(理论上，POST传递的数据量没有限制)</li>
<li>一般用来修改、增加、删除数据</li>
</ul>
</li>
</ul>
</li>
<li>GET和POST的选择<ul>
<li>如果要传递大量数据，比如文件上传，只能用POST请求</li>
<li>GET的安全性比POST要差些，如果包含机密\敏感信息，建议用POST</li>
<li>如果是增加、修改、删除数据，建议使用POST</li>
<li>如果仅仅是索取数据（数据查询），建议使用GET</li>
</ul>
</li>
<li>在iOS中，常见的发送HTTP请求的方案有<ul>
<li>苹果原生<ul>
<li>NSURLConnection：用法简单，最古老最经典最直接的一种方案</li>
<li>NSURLSession：功能比NSURLConnection更加强大，苹果目前比较推荐使用这种技术【2013推出，iOS7开始出的技术】</li>
<li>CFNetwork：NSURL*的底层，纯C语言</li>
</ul>
</li>
<li>第三方框架<ul>
<li>ASIHttpRequest：外号“HTTP终结者”，功能极其强大，可惜早已停止更新</li>
<li>AFNetworking：简单易用，提供了基本够用的常用功能，维护和使用者多</li>
<li>MKNetworkKit：简单易用，产自三哥的故乡印度，维护和使用者少</li>
</ul>
</li>
</ul>
</li>
<li>HTTP协议规定：1个完整的由客户端发给服务器的HTTP请求中包含以下内容<ul>
<li>请求头：包含了对客户端的环境描述、客户端请求信息等<ul>
<li>GET /minion.png HTTP/1.1   // 包含了请求方法、请求资源路径、HTTP协议版本</li>
<li>Host: 120.25.226.186:32812     // 客户端想访问的服务器主机地址</li>
<li>User-Agent: Mozilla/5.0  // 客户端的类型，客户端的软件环境</li>
<li>Accept: text/html, <em>/</em>     // 客户端所能接收的数据类型</li>
<li>Accept-Language: zh-cn     // 客户端的语言环境</li>
<li>Accept-Encoding: gzip     // 客户端支持的数据压缩格式</li>
</ul>
</li>
<li>请求体：客户端发给服务器的具体数据，比如文件数据(POST请求才会有)</li>
</ul>
</li>
<li>HTTP协议规定：1个完整的HTTP响应中包含以下内容<ul>
<li>响应头：包含了对服务器的描述、对返回数据的描述<ul>
<li>HTTP/1.1 200 OK            // 包含了HTTP协议版本、状态码、状态英文名称</li>
<li>Server: Apache-Coyote/1.1         // 服务器的类型</li>
<li>Content-Type: image/jpeg         // 返回数据的类型</li>
<li>Content-Length: 56811         // 返回数据的长度</li>
<li>Date: Mon, 23 Jun 2014 12:54:52 GMT    // 响应的时间</li>
</ul>
</li>
<li>响应体：服务器返回给客户端的具体数据，比如文件数据</li>
</ul>
</li>
<li>常见响应状态码<ul>
<li>200 请求成功</li>
<li>400 客户端请求的语法错误，服务器无法解析</li>
<li>404 服务器无法根据客户端的请求找到资源</li>
<li>500 服务器内部错误，无法完成请求</li>
</ul>
</li>
</ul>
<p>NSURLConnection存在的问题
复杂的网络操作需要通过代理来实现
代理方式默认在主线程工作
Connection一旦请求发出去,就等待服务器一点一点给它数据，所以有个运行循环在等待服务器给它数据，它是在runloop里面接收服务器返回的数据，connection内部会关连当前线程对应的runloop不断给当前线程对应的runloop传递消息，runloop一旦接收到source就会处理，而子线程的runloop默认是不启动的
只提供了start&amp;cancel方法，不能暂停
在使用多线程时需要使用运行循环</p>
<h2 id="http">创建HTTP请求</h2>
<ul>
<li>GET</li>
</ul>
<pre><code class="lang-objc"><span class="hljs-comment">// 请求路径</span>
<span class="hljs-built_in">NSString</span> *urlString = <span class="hljs-string">@"http://yshow.com?name=张三&amp;pwd=123"</span>;
urlString = [urlString stringByAddingPercentEscapesUsingEncoding:NSUTF8StringEncoding];
<span class="hljs-comment">// 创建URL</span>
<span class="hljs-built_in">NSURL</span> *url = [<span class="hljs-built_in">NSURL</span> URLWithString:urlString];
<span class="hljs-comment">// 创建请求</span>
NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:url];
<span class="hljs-comment">// 设置请求方法（默认就是GET请求）</span>
request<span class="hljs-variable">.HTTPMethod</span> = <span class="hljs-string">@"GET"</span>;
</code></pre>
<ul>
<li>POST</li>
</ul>
<pre><code class="lang-objc"><span class="hljs-comment">// 请求路径</span>
<span class="hljs-built_in">NSString</span> *urlString = <span class="hljs-string">@"http://yshow.com/图片"</span>;
urlString = [urlString stringByAddingPercentEscapesUsingEncoding:NSUTF8StringEncoding];
<span class="hljs-comment">// 创建URL</span>
<span class="hljs-built_in">NSURL</span> *url = [<span class="hljs-built_in">NSURL</span> URLWithString:urlString];
<span class="hljs-comment">// 2.创建请求</span>
NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:url];
<span class="hljs-comment">// 设置请求方法</span>
request<span class="hljs-variable">.HTTPMethod</span> = <span class="hljs-string">@"POST"</span>;
<span class="hljs-comment">// 设置请求体 已经对中文做了处理</span>
request<span class="hljs-variable">.HTTPBody</span> = [<span class="hljs-string">@"username=李军&amp;pwd=520it"</span> dataUsingEncoding:NSUTF8StringEncoding];
<span class="hljs-comment">// 设置超时(5秒后超时)</span>
request<span class="hljs-variable">.timeoutInterval</span> = <span class="hljs-number">5</span>;
<span class="hljs-comment">// 设置请求头</span>
<span class="hljs-comment">//[request setValue:@"iOS 9.0" forHTTPHeaderField:@"User-Agent"];</span>
</code></pre>
<h2 id="nsurlconnectionhttp">使用NSURLConnection发送HTTP请求</h2>
<h3 id="">发送同步请求</h3>
<pre><code class="lang-objc">+ (<span class="hljs-built_in">NSData</span> *)sendSynchronousRequest:(<span class="hljs-built_in">NSURLRequest</span> *)request returningResponse:(NSURLResponse **)response error:(<span class="hljs-built_in">NSError</span> **)error;
<span class="hljs-comment">// 0.请求路径</span>
<span class="hljs-built_in">NSURL</span> *url = [<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@"http://120.25.226.186:32812/video"</span>];
<span class="hljs-comment">// 1.创建请求对象</span>
<span class="hljs-built_in">NSURLRequest</span> *request = [<span class="hljs-built_in">NSURLRequest</span> requestWithURL:url];
<span class="hljs-comment">// 2.发送请求</span>
NSHTTPURLResponse *response = <span class="hljs-literal">nil</span>;
<span class="hljs-built_in">NSError</span> *error = <span class="hljs-literal">nil</span>;
<span class="hljs-comment">//sendSynchronousRequest这个方法是阻塞式的，会在当前线程发送请求，当服务器的数据完全返回时，这个方法才会返回，代码才会继续往下执行</span>
<span class="hljs-built_in">NSData</span> *data = [<span class="hljs-built_in">NSURLConnection</span> sendSynchronousRequest:request returningResponse:&amp;response error:&amp;error];
<span class="hljs-comment">// 3.解析服务器返回的数据（解析成字符串）</span>
<span class="hljs-built_in">NSString</span> *string = [[<span class="hljs-built_in">NSString</span> alloc] initWithData:data encoding:NSUTF8StringEncoding];
<span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@ %@"</span>, string, response<span class="hljs-variable">.allHeaderFields</span>);<span class="hljs-comment">//响应头</span>
</code></pre>
<h3 id="-block">发送异步请求-block</h3>
<pre><code class="lang-objc">异步请求
<span class="hljs-comment">// 0.请求路径</span>
<span class="hljs-built_in">NSURL</span> *url = [<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@"http://120.25.226.186:32812/login?username=520it&amp;pwd=520it"</span>];
<span class="hljs-comment">// 1.创建请求对象</span>
<span class="hljs-built_in">NSURLRequest</span> *request = [<span class="hljs-built_in">NSURLRequest</span> requestWithURL:url];
<span class="hljs-comment">// 2.发送请求</span>
<span class="hljs-comment">// 会自动开启一个子线程去发送请求</span>
<span class="hljs-comment">// 当请求完毕（成功\失败），会自动调用handler这个block</span>
<span class="hljs-comment">// handler这个block会放到queue这个队列中执行</span>
[<span class="hljs-built_in">NSURLConnection</span> sendAsynchronousRequest:request queue:[NSOperationQueue mainQueue] completionHandler:^(NSURLResponse * _Nullable response, <span class="hljs-built_in">NSData</span> * _Nullable data, <span class="hljs-built_in">NSError</span> * _Nullable connectionError) {
    <span class="hljs-comment">//3.解析服务器返回的数据（解析成字符串）</span>
    <span class="hljs-built_in">NSString</span> *string = [[<span class="hljs-built_in">NSString</span> alloc] initWithData:data encoding:NSUTF8StringEncoding];
    NSHTTPURLResponse *r = (NSHTTPURLResponse*)response;
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@ %@ %zd"</span>,string,r<span class="hljs-variable">.allHeaderFields</span>,r<span class="hljs-variable">.statusCode</span>);
}];
</code></pre>
<h3 id="-delegate">发送异步请求-delegate</h3>
<ul>
<li>创建NSURLConnection对象</li>
</ul>
<pre><code class="lang-objc"><span class="hljs-comment">// startImmediately==YES，创建完毕后，自动发送异步请求</span>
- (instancetype)initWithRequest:(<span class="hljs-built_in">NSURLRequest</span> *)request delegate:(<span class="hljs-keyword">id</span>)delegate startImmediately:(<span class="hljs-built_in">BOOL</span>)startImmediately;
- (instancetype)initWithRequest:(<span class="hljs-built_in">NSURLRequest</span> *)request delegate:(<span class="hljs-keyword">id</span>)delegate; <span class="hljs-comment">// 创建完毕后，自动发送异步请求</span>
+ (<span class="hljs-built_in">NSURLConnection</span>*)connectionWithRequest:(<span class="hljs-built_in">NSURLRequest</span> *)request delegate:(<span class="hljs-keyword">id</span>)delegate; <span class="hljs-comment">// 创建完毕后，自动发送异步请求</span>

<span class="hljs-comment">// 0.请求路径</span>
<span class="hljs-built_in">NSString</span> *urlStr = <span class="hljs-string">@"http://120.25.226.186:32812/login2?username=李军&amp;pwd=520it"</span>;
<span class="hljs-comment">// 将中文URL进行转码</span>
urlStr = [urlStr stringByAddingPercentEscapesUsingEncoding:NSUTF8StringEncoding];
<span class="hljs-built_in">NSURL</span> *url = [<span class="hljs-built_in">NSURL</span> URLWithString:urlStr];
<span class="hljs-comment">// 1.创建请求对象</span>
*<span class="hljs-built_in">NSURLRequest</span> *request = [<span class="hljs-built_in">NSURLRequest</span> requestWithURL:url];
*[<span class="hljs-built_in">NSURLConnection</span> connectionWithRequest:request delegate:<span class="hljs-keyword">self</span>];
*<span class="hljs-built_in">NSURLConnection</span> *conn = [[<span class="hljs-built_in">NSURLConnection</span> alloc] initWithRequest:request delegate:<span class="hljs-keyword">self</span> startImmediately:<span class="hljs-literal">NO</span>];
startImmediately设为<span class="hljs-literal">NO</span>需要手动启动
[conn start];
</code></pre>
<ul>
<li>发送请求</li>
</ul>
<pre><code class="lang-objc">[connection start];
</code></pre>
<ul>
<li>遵守<code>NSURLConnectionDataDelegate</code>协议，实现协议中的代理方法</li>
</ul>
<pre><code class="lang-objc"><span class="hljs-comment">// 当接收到服务器的响应时就会调用</span>
- (<span class="hljs-keyword">void</span>)connection:(<span class="hljs-built_in">NSURLConnection</span> *)connection didReceiveResponse:(NSURLResponse *)response;

<span class="hljs-comment">// 每当接收到服务器返回的数据时就会调用1次（数据量大的时候，这个方法就会被调用多次）</span>
- (<span class="hljs-keyword">void</span>)connection:(<span class="hljs-built_in">NSURLConnection</span> *)connection didReceiveData:(<span class="hljs-built_in">NSData</span> *)data;

<span class="hljs-comment">// 当服务器的数据完全返回时调用（服务器的数据接收完毕）</span>
- (<span class="hljs-keyword">void</span>)connectionDidFinishLoading:(<span class="hljs-built_in">NSURLConnection</span> *)connection;

<span class="hljs-comment">// 当请求失败的时候调用</span>
- (<span class="hljs-keyword">void</span>)connection:(<span class="hljs-built_in">NSURLConnection</span> *)connection didFailWithError:(<span class="hljs-built_in">NSError</span> *)error;
</code></pre>
<ul>
<li>取消请求</li>
</ul>
<pre><code class="lang-objc">[connection cancel];
</code></pre>
<h2 id="nsstringnsdata">NSString和NSData的互相转换</h2>
<ul>
<li>NSString -&gt; NSData</li>
</ul>
<pre><code class="lang-objc"><span class="hljs-built_in">NSData</span> *data = [<span class="hljs-string">@"520it.com"</span> dataUsingEncoding:NSUTF8StringEncoding];
</code></pre>
<ul>
<li>NSData -&gt; NSString</li>
</ul>
<pre><code class="lang-objc"><span class="hljs-built_in">NSString</span> *string = [[<span class="hljs-built_in">NSString</span> alloc] initWithData:data encoding:NSUTF8StringEncoding];
</code></pre>
<h2 id="json">JSON</h2>
<ul>
<li>JSON是一种轻量级的数据格式，一般用于数据交互</li>
<li>JSON的格式很像OC中的字典和数组<ul>
<li>{&quot;name&quot; : &quot;jack&quot;, &quot;age&quot; : 10}</li>
<li>标准JSON格式的注意点：key必须用双引号</li>
</ul>
</li>
<li>在iOS中，JSON的常见解析方案有4种<ul>
<li>第三方框架：JSONKit、SBJson、TouchJSON（性能从左到右，越差）</li>
<li>苹果原生（自带）：NSJSONSerialization（性能最好）</li>
</ul>
</li>
<li>NSJSONSerialization的常见方法<ul>
<li>JSON数据（NSData） -&gt; OC对象（Foundation Object）</li>
</ul>
</li>
</ul>
<pre><code class="lang-objc"><span class="hljs-comment">// 利用NSJSONSerialization类</span>
- {} -&gt; <span class="hljs-built_in">NSDictionary</span> @{}
- [] -&gt; <span class="hljs-built_in">NSArray</span> @[]
- <span class="hljs-string">"jack"</span> -&gt; <span class="hljs-built_in">NSString</span> <span class="hljs-string">@"jack"</span>
- <span class="hljs-number">10</span> -&gt; <span class="hljs-built_in">NSNumber</span> @<span class="hljs-number">10</span>
- <span class="hljs-number">10.5</span> -&gt; <span class="hljs-built_in">NSNumber</span> @<span class="hljs-number">10.5</span>
- <span class="hljs-literal">true</span> -&gt; <span class="hljs-built_in">NSNumber</span> @<span class="hljs-number">1</span>
- <span class="hljs-literal">false</span> -&gt; <span class="hljs-built_in">NSNumber</span> @<span class="hljs-number">0</span>
- null -&gt; NSNull

- NSJSONReadingOptions
    - NSJSONReadingMutableContainers = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">0</span>)
        - 创建出来的数组和字典就是可变
    - NSJSONReadingMutableLeaves = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">1</span>)
        - 数组或者字典里面的字符串是可变的
    - NSJSONReadingAllowFragments
        - 允许解析出来的对象不是字典或者数组，比如直接是字符串或者<span class="hljs-built_in">NSNumber</span>
+ (<span class="hljs-keyword">id</span>)JSONObjectWithData:(<span class="hljs-built_in">NSData</span> *)data options:(NSJSONReadingOptions)opt error:(<span class="hljs-built_in">NSError</span> **)error;
<span class="hljs-built_in">NSString</span> *json = <span class="hljs-string">@"10"</span>;
<span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@"</span>,[NSJSONSerialization JSONObjectWithData:[json dataUsingEncoding:NSUTF8StringEncoding] options:NSJSONReadingAllowFragments error:<span class="hljs-literal">nil</span>]);
</code></pre>
<ul>
<li>OC对象（Foundation Object）-&gt; JSON数据（NSData）</li>
</ul>
<pre><code class="lang-objc"><span class="hljs-comment">// 利用NSJSONSerialization类</span>
+ (<span class="hljs-built_in">NSData</span> *)dataWithJSONObject:(<span class="hljs-keyword">id</span>)obj options:(NSJSONWritingOptions)opt error:(<span class="hljs-built_in">NSError</span> **)error;
</code></pre>
<h2 id="json">格式化服务器返回的JSON数据</h2>
<ul>
<li>在线格式化：<a href="http://tool.oschina.net/codeformat/json" target="_blank">http://tool.oschina.net/codeformat/json</a></li>
<li>将服务器返回的字典或者数组写成plist文件</li>
</ul>
<h2 id="xml">XML语法</h2>
<ul>
<li>在XML文档的最前面，必须编写一个文档声明，用来声明XML文档的类型
&lt;?xml version=&quot;1.0&quot;?&gt;
用encoding属性说明文档的字符编码
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
一个元素包括了开始标签和结束标签
<string>en</string> en是元素的内容
没有元素内容 <string></string> 或<string/>
规范的xml文档最多只有1个根元素，其他元素都是根元素的子孙元素
XML中的所有空格和换行，都会当做具体内容处理
一个元素可以拥有多个属性
<video name=“小黄人第01部” length=“30”/>
xml数据解析有两种解析方式：DOM解析与SAX解析。
DOM解析：一次性将整个XML文档加载进内存，支持删除、修改、重新排列等多种功能比较适合解析小文件，解析速度慢
SAX解析：只能读，不能修改，从根元素开始，按顺序一个元素一个元素往下解析，比较适合解析大文件，解析速度快
在iOS中，解析XML的手段有很多
苹果原生
NSXMLParser: SAX方式解析，使用简单
第三方框架
libxml2: 纯C语言，默认包含在iOSSDK中，同时支持DOM和SAX方式解析
GDataXML:DOM方式解析，由Google开发，基于libxml2
xml解析方式选择：
大文件：NSXMLParser、libxml2
小文件：GDataXML
GDataXML配置
GDataXML基于libxml2库，得做以下配置
导入libxml2.2.dylib库
设置libxml2的头文件搜索路径(为找到libxml2库所有头文件)
在Head Search Path中加入/usr/include/libxml2
设置链接参数(自动链接libxml2库)
在Other Linker Flags中加入-lxml2
GDataXML中常用类
GDataXMLDocument:代表整个XML文档
GDataXMLElement 代表文档中的每个元素</li>
</ul>
<h2 id="nsoutputstream">NSOutputStream实现大文件下载</h2>
<pre><code class="lang-objc">- (<span class="hljs-keyword">void</span>)connection:(<span class="hljs-built_in">NSURLConnection</span> *)connection didReceiveResponse:(NSURLResponse *)response
{
<span class="hljs-comment">// response.suggestedFilename : 服务器那边的文件名</span>
<span class="hljs-comment">// 文件路径</span>
<span class="hljs-built_in">NSString</span> *caches = [NSSearchPathForDirectoriesInDomains(NSCachesDirectory, NSUserDomainMask, <span class="hljs-literal">YES</span>) lastObject];
<span class="hljs-built_in">NSString</span> *file = [caches stringByAppendingPathComponent:response<span class="hljs-variable">.suggestedFilename</span>];
<span class="hljs-comment">// 利用NSOutputStream往Path中写入数据（append为YES的话，每次写入都是追加到文件尾部）</span>
<span class="hljs-keyword">self</span><span class="hljs-variable">.stream</span> = [[NSOutputStream alloc] initToFileAtPath:file append:<span class="hljs-literal">YES</span>];
<span class="hljs-comment">// 打开流(如果文件不存在，会自动创建)</span>
[<span class="hljs-keyword">self</span><span class="hljs-variable">.stream</span> open];
}
- (<span class="hljs-keyword">void</span>)connection:(<span class="hljs-built_in">NSURLConnection</span> *)connection didReceiveData:(<span class="hljs-built_in">NSData</span> *)data
{
    [<span class="hljs-keyword">self</span><span class="hljs-variable">.stream</span> write:[data bytes] maxLength:data<span class="hljs-variable">.length</span>];
}
- (<span class="hljs-keyword">void</span>)connectionDidFinishLoading:(<span class="hljs-built_in">NSURLConnection</span> *)connection
{
    [<span class="hljs-keyword">self</span><span class="hljs-variable">.stream</span> close];
}
</code></pre>
<h2 id="nsurlsession">NSURLSession</h2>
<ul>
<li>get</li>
</ul>
<pre><code class="lang-objc"><span class="hljs-comment">// 获得NSURLSession对象</span>
<span class="hljs-built_in">NSURLSession</span> *session = [<span class="hljs-built_in">NSURLSession</span> sharedSession];
<span class="hljs-comment">// 创建任务</span>
<span class="hljs-built_in">NSURLSessionDataTask</span> *task = [session dataTaskWithRequest:[<span class="hljs-built_in">NSURLRequest</span> requestWithURL:[<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@"http://120.25.226.186:32812/login?username=123&amp;pwd=4324"</span>]] completionHandler:^(<span class="hljs-built_in">NSData</span> *data, NSURLResponse *response, <span class="hljs-built_in">NSError</span> *error) {
        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@"</span>, [NSJSONSerialization JSONObjectWithData:data options:kNilOptions error:<span class="hljs-literal">nil</span>]);
}];
<span class="hljs-comment">// 启动任务</span>
[task resume];

<span class="hljs-comment">// 获得NSURLSession对象</span>
<span class="hljs-built_in">NSURLSession</span> *session = [<span class="hljs-built_in">NSURLSession</span> sharedSession];
<span class="hljs-comment">// 创建任务</span>
<span class="hljs-built_in">NSURLSessionDataTask</span> *task = [session dataTaskWithURL:[<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@"http://120.25.226.186:32812/login?username=123&amp;pwd=4324"</span>] completionHandler:^(<span class="hljs-built_in">NSData</span> *data, NSURLResponse *response, <span class="hljs-built_in">NSError</span> *error) {
        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@"</span>, [NSJSONSerialization JSONObjectWithData:data options:kNilOptions error:<span class="hljs-literal">nil</span>]);
    }];
<span class="hljs-comment">// 启动任务</span>
[task resume];
</code></pre>
<ul>
<li>post</li>
</ul>
<pre><code class="lang-objc"><span class="hljs-comment">// 获得NSURLSession对象</span>
<span class="hljs-built_in">NSURLSession</span> *session = [<span class="hljs-built_in">NSURLSession</span> sharedSession];
<span class="hljs-comment">// 创建请求</span>
NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:[<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@"http://120.25.226.186:32812/login"</span>]];
request<span class="hljs-variable">.HTTPMethod</span> = <span class="hljs-string">@"POST"</span>; <span class="hljs-comment">// 请求方法</span>
request<span class="hljs-variable">.HTTPBody</span> = [<span class="hljs-string">@"username=520it&amp;pwd=520it"</span> dataUsingEncoding:NSUTF8StringEncoding]; <span class="hljs-comment">// 请求体</span>
<span class="hljs-comment">// 创建任务</span>
<span class="hljs-built_in">NSURLSessionDataTask</span> *task = [session dataTaskWithRequest:request completionHandler:^(<span class="hljs-built_in">NSData</span> *data, NSURLResponse *response, <span class="hljs-built_in">NSError</span> *error) {
        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@"</span>, [NSJSONSerialization JSONObjectWithData:data options:kNilOptions error:<span class="hljs-literal">nil</span>]);
    }];
<span class="hljs-comment">// 启动任务</span>
[task resume];
</code></pre>
<ul>
<li>upload</li>
</ul>
<pre><code class="lang-objc"><span class="hljs-preprocessor">#define XMGBoundary @<span class="hljs-title">"520it"</span></span>
<span class="hljs-preprocessor">#define XMGEncode(string) [string dataUsingEncoding:NSUTF8StringEncoding]</span>
<span class="hljs-preprocessor">#define XMGNewLine [@<span class="hljs-title">"\r\n"</span> dataUsingEncoding:NSUTF8StringEncoding]</span>
- (<span class="hljs-built_in">NSURLSession</span> *)session
{
    <span class="hljs-keyword">if</span> (!_session) {
        NSURLSessionConfiguration *cfg = [NSURLSessionConfiguration defaultSessionConfiguration];
        cfg<span class="hljs-variable">.timeoutIntervalForRequest</span> = <span class="hljs-number">10</span>;
        <span class="hljs-comment">// 是否允许使用蜂窝网络（手机自带网络）</span>
        cfg<span class="hljs-variable">.allowsCellularAccess</span> = <span class="hljs-literal">YES</span>;
        _session = [<span class="hljs-built_in">NSURLSession</span> sessionWithConfiguration:cfg];
    }
    <span class="hljs-keyword">return</span> _session;
}
NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:[<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@"http://120.25.226.186:32812/upload"</span>]];
    request<span class="hljs-variable">.HTTPMethod</span> = <span class="hljs-string">@"POST"</span>;
    <span class="hljs-comment">// 设置请求头(告诉服务器,这是一个文件上传的请求)</span>
    [request setValue:[<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@"multipart/form-data; boundary=%@"</span>, XMGBoundary] forHTTPHeaderField:<span class="hljs-string">@"Content-Type"</span>];

    <span class="hljs-comment">// 设置请求体</span>
    NSMutableData *body = [NSMutableData data];

    <span class="hljs-comment">// 文件参数</span>
    <span class="hljs-comment">// 分割线</span>
    [body appendData:XMGEncode(<span class="hljs-string">@"--"</span>)];
    [body appendData:XMGEncode(XMGBoundary)];
    [body appendData:XMGNewLine];

    <span class="hljs-comment">// 文件参数名</span>
    [body appendData:XMGEncode([<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@"Content-Disposition: form-data; name=\"file\"; filename=\"test.png\""</span>])];
    [body appendData:XMGNewLine];

    <span class="hljs-comment">// 文件的类型</span>
    [body appendData:XMGEncode([<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@"Content-Type: image/png"</span>])];
    [body appendData:XMGNewLine];

    <span class="hljs-comment">// 文件数据</span>
    [body appendData:XMGNewLine];
    [body appendData:[<span class="hljs-built_in">NSData</span> dataWithContentsOfFile:<span class="hljs-string">@"/Users/LiJun/Downloads/banner_holdImage@2x.png"</span>]];
    [body appendData:XMGNewLine];

    <span class="hljs-comment">// 结束标记</span>
    <span class="hljs-comment">/*
     --分割线--\r\n
     */</span>
    [body appendData:XMGEncode(<span class="hljs-string">@"--"</span>)];
    [body appendData:XMGEncode(XMGBoundary)];
    [body appendData:XMGEncode(<span class="hljs-string">@"--"</span>)];
    [body appendData:XMGNewLine];

    [[<span class="hljs-keyword">self</span><span class="hljs-variable">.session</span> uploadTaskWithRequest:request fromData:body completionHandler:^(<span class="hljs-built_in">NSData</span> *data, NSURLResponse *response, <span class="hljs-built_in">NSError</span> *error) {
        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"-------%@"</span>, [NSJSONSerialization JSONObjectWithData:data options:kNilOptions error:<span class="hljs-literal">nil</span>]);
    }] resume];
</code></pre>
<ul>
<li>down 不需要离线断点</li>
</ul>
<pre><code class="lang-objc"><span class="hljs-comment">// 获得NSURLSession对象</span>
<span class="hljs-built_in">NSURLSession</span> *session = [<span class="hljs-built_in">NSURLSession</span> sharedSession];
<span class="hljs-comment">// 获得下载任务</span>
<span class="hljs-built_in">NSURLSessionDownloadTask</span> *task = [session downloadTaskWithURL:[<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@"http://120.25.226.186:32812/resources/videos/minion_01.mp4"</span>] completionHandler:^(<span class="hljs-built_in">NSURL</span> *location, NSURLResponse *response, <span class="hljs-built_in">NSError</span> *error) {
    <span class="hljs-comment">// 文件将来存放的真实路径</span>
    <span class="hljs-built_in">NSString</span> *file = [[NSSearchPathForDirectoriesInDomains(NSCachesDirectory, NSUserDomainMask, <span class="hljs-literal">YES</span>) lastObject] stringByAppendingPathComponent:response<span class="hljs-variable">.suggestedFilename</span>];

    <span class="hljs-comment">// 剪切location的临时文件到真实路径</span>
    <span class="hljs-built_in">NSFileManager</span> *mgr = [<span class="hljs-built_in">NSFileManager</span> defaultManager];
    [mgr moveItemAtURL:location toURL:[<span class="hljs-built_in">NSURL</span> fileURLWithPath:file] error:<span class="hljs-literal">nil</span>];
}];
<span class="hljs-comment">// 启动任务</span>
[task resume];

NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:[<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@"http://120.25.226.186:32812/resources/videos/minion_01.mp4"</span>]];
    <span class="hljs-built_in">NSURLSessionDownloadTask</span> *task = [[<span class="hljs-built_in">NSURLSession</span> sharedSession] downloadTaskWithRequest:request completionHandler:^(<span class="hljs-built_in">NSURL</span> * _Nullable location, NSURLResponse * _Nullable response, <span class="hljs-built_in">NSError</span> * _Nullable error) {

    }];
    [task resume];
</code></pre>
<ul>
<li>download 断点下载</li>
</ul>
<pre><code class="lang-objc">    <span class="hljs-comment">// 获得NSURLSession对象</span>
    <span class="hljs-built_in">NSURLSession</span> *session = [<span class="hljs-built_in">NSURLSession</span> sessionWithConfiguration:[NSURLSessionConfiguration defaultSessionConfiguration] delegate:<span class="hljs-keyword">self</span> delegateQueue:[[NSOperationQueue alloc] init]];
    <span class="hljs-comment">// 获得下载任务</span>
    <span class="hljs-built_in">NSURLSessionDownloadTask</span> *task = [session downloadTaskWithURL:[<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@"http://120.25.226.186:32812/resources/videos/minion_01.mp4"</span>]];
    <span class="hljs-comment">// 启动任务</span>
    [task resume];
    <span class="hljs-comment">//暂停下载</span>
    [task suspend];
    <span class="hljs-comment">//继续下载</span>
    [task resume];

- (<span class="hljs-keyword">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session task:(NSURLSessionTask *)task didCompleteWithError:(<span class="hljs-built_in">NSError</span> *)error
{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"didCompleteWithError"</span>);
}
- (<span class="hljs-keyword">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session downloadTask:(<span class="hljs-built_in">NSURLSessionDownloadTask</span> *)downloadTask didResumeAtOffset:(int64_t)fileOffset expectedTotalBytes:(int64_t)expectedTotalBytes
{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"didResumeAtOffset"</span>);
}
<span class="hljs-comment">/**
 * 每当写入数据到临时文件时，就会调用一次这个方法
 * totalBytesExpectedToWrite:总大小
 * totalBytesWritten: 已经写入的大小
 * bytesWritten: 这次写入多少
 */</span>
- (<span class="hljs-keyword">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session downloadTask:(<span class="hljs-built_in">NSURLSessionDownloadTask</span> *)downloadTask didWriteData:(int64_t)bytesWritten totalBytesWritten:(int64_t)totalBytesWritten totalBytesExpectedToWrite:(int64_t)totalBytesExpectedToWrite
{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"--------%f"</span>, <span class="hljs-number">1.0</span> * totalBytesWritten / totalBytesExpectedToWrite);
}
<span class="hljs-comment">/**
 * 下载完毕就会调用一次这个方法
 */</span>
- (<span class="hljs-keyword">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session downloadTask:(<span class="hljs-built_in">NSURLSessionDownloadTask</span> *)downloadTask didFinishDownloadingToURL:(<span class="hljs-built_in">NSURL</span> *)location
{
    <span class="hljs-comment">// 文件将来存放的真实路径</span>
    <span class="hljs-built_in">NSString</span> *file = [[NSSearchPathForDirectoriesInDomains(NSCachesDirectory, NSUserDomainMask, <span class="hljs-literal">YES</span>) lastObject] stringByAppendingPathComponent:downloadTask<span class="hljs-variable">.response</span><span class="hljs-variable">.suggestedFilename</span>];

    <span class="hljs-comment">// 剪切location的临时文件到真实路径</span>
    <span class="hljs-built_in">NSFileManager</span> *mgr = [<span class="hljs-built_in">NSFileManager</span> defaultManager];
    [mgr moveItemAtURL:location toURL:[<span class="hljs-built_in">NSURL</span> fileURLWithPath:file] error:<span class="hljs-literal">nil</span>];
}
</code></pre>
<ul>
<li>NSURLSessionDataDelegate 实现离线下载</li>
</ul>
<pre><code class="lang-objc"><span class="hljs-comment">// 所需要下载的文件的URL</span>
<span class="hljs-preprocessor">#define XMGFileURL @<span class="hljs-title">"http://120.25.226.186:32812/resources/videos/minion_01.mp4"</span></span>
<span class="hljs-comment">// 文件名（沙盒中的文件名）</span>
<span class="hljs-preprocessor">#define XMGFilename XMGFileURL.md5String</span>
<span class="hljs-comment">// 文件的存放路径（caches）</span>
<span class="hljs-preprocessor">#define XMGFileFullpath [[NSSearchPathForDirectoriesInDomains(NSCachesDirectory, NSUserDomainMask, YES) lastObject] stringByAppendingPathComponent:XMGFilename]</span>
<span class="hljs-comment">// 存储文件总长度的文件路径（caches）</span>
<span class="hljs-preprocessor">#define XMGTotalLengthFullpath [[NSSearchPathForDirectoriesInDomains(NSCachesDirectory, NSUserDomainMask, YES) lastObject] stringByAppendingPathComponent:@<span class="hljs-title">"totalLength.xmg"</span>]</span>
<span class="hljs-comment">// 文件的已下载长度</span>
<span class="hljs-preprocessor">#define XMGDownloadLength [[[NSFileManager defaultManager] attributesOfItemAtPath:XMGFileFullpath error:nil][NSFileSize] integerValue]</span>
<span class="hljs-comment">/** 下载任务 */</span>
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSURLSessionDataTask</span> *task;
<span class="hljs-comment">/** session */</span>
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSURLSession</span> *session;
<span class="hljs-comment">/** 写文件的流对象 */</span>
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) NSOutputStream *stream;
<span class="hljs-comment">/** 文件的总长度 */</span>
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">assign</span>) <span class="hljs-built_in">NSInteger</span> totalLength;
<span class="hljs-comment">// 获得NSURLSession对象</span>
- (<span class="hljs-built_in">NSURLSession</span> *)session
{
    <span class="hljs-keyword">if</span> (!_session) {
        _session = [<span class="hljs-built_in">NSURLSession</span> sessionWithConfiguration:[NSURLSessionConfiguration defaultSessionConfiguration] delegate:<span class="hljs-keyword">self</span> delegateQueue:[[NSOperationQueue alloc] init]];
    }
    <span class="hljs-keyword">return</span> _session;
}

- (NSOutputStream *)stream
{
    <span class="hljs-keyword">if</span> (!_stream) {
        _stream = [NSOutputStream outputStreamToFileAtPath:XMGFileFullpath append:<span class="hljs-literal">YES</span>];
    }
    <span class="hljs-keyword">return</span> _stream;
}

- (<span class="hljs-built_in">NSURLSessionDataTask</span> *)task
{
    <span class="hljs-keyword">if</span> (!_task) {
        <span class="hljs-built_in">NSInteger</span> totalLength = [[<span class="hljs-built_in">NSDictionary</span> dictionaryWithContentsOfFile:XMGTotalLengthFullpath][XMGFilename] integerValue];
        <span class="hljs-keyword">if</span> (totalLength &amp;&amp; XMGDownloadLength == totalLength) {
            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"----文件已经下载过了"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;
        }

        <span class="hljs-comment">// 创建请求</span>
        NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:[<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@"http://120.25.226.186:32812/resources/videos/minion_01.mp4"</span>]];

        <span class="hljs-comment">// 设置请求头</span>
        <span class="hljs-built_in">NSString</span> *range = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@"bytes=%zd-"</span>, XMGDownloadLength];
        [request setValue:range forHTTPHeaderField:<span class="hljs-string">@"Range"</span>];

        <span class="hljs-comment">// 创建一个Data任务</span>
        _task = [<span class="hljs-keyword">self</span><span class="hljs-variable">.session</span> dataTaskWithRequest:request];
    }
    <span class="hljs-keyword">return</span> _task;
}
<span class="hljs-comment">// 启动任务</span>
[<span class="hljs-keyword">self</span><span class="hljs-variable">.task</span> resume];
<span class="hljs-comment">//暂停下载</span>
[<span class="hljs-keyword">self</span><span class="hljs-variable">.task</span> suspend];
<span class="hljs-comment">//1.接收到服务器的响应</span>
- (<span class="hljs-keyword">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session dataTask:(<span class="hljs-built_in">NSURLSessionDataTask</span> *)dataTask didReceiveResponse:(NSHTTPURLResponse *)response completionHandler:(<span class="hljs-keyword">void</span> (^)(NSURLSessionResponseDisposition))completionHandler
{
    <span class="hljs-comment">// 打开流</span>
    [<span class="hljs-keyword">self</span><span class="hljs-variable">.stream</span> open];
    <span class="hljs-comment">// 获得服务器这次请求 返回数据的总长度</span>
    <span class="hljs-keyword">self</span><span class="hljs-variable">.totalLength</span> = [response<span class="hljs-variable">.allHeaderFields</span>[<span class="hljs-string">@"Content-Length"</span>] integerValue] + XMGDownloadLength;
    <span class="hljs-comment">// 存储总长度</span>
    <span class="hljs-built_in">NSMutableDictionary</span> *dict = [<span class="hljs-built_in">NSMutableDictionary</span> dictionaryWithContentsOfFile:XMGTotalLengthFullpath];
    <span class="hljs-keyword">if</span> (dict == <span class="hljs-literal">nil</span>) dict = [<span class="hljs-built_in">NSMutableDictionary</span> dictionary];
    dict[XMGFilename] = @(<span class="hljs-keyword">self</span><span class="hljs-variable">.totalLength</span>);
    [dict writeToFile:XMGTotalLengthFullpath atomically:<span class="hljs-literal">YES</span>];

    <span class="hljs-comment">// 接收这个请求，允许接收服务器的数据</span>
    completionHandler(NSURLSessionResponseAllow);
}
<span class="hljs-comment">//2.接收到服务器返回的数据（这个方法可能会被调用N次）</span>
- (<span class="hljs-keyword">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session dataTask:(<span class="hljs-built_in">NSURLSessionDataTask</span> *)dataTask didReceiveData:(<span class="hljs-built_in">NSData</span> *)data
{
    <span class="hljs-comment">// 利用NSOutputStream写入数据</span>
    [<span class="hljs-keyword">self</span><span class="hljs-variable">.stream</span> write:data<span class="hljs-variable">.bytes</span> maxLength:data<span class="hljs-variable">.length</span>];

    <span class="hljs-comment">// 计算下载进度</span>
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%f"</span>, <span class="hljs-number">1.0</span> * XMGDownloadLength / <span class="hljs-keyword">self</span><span class="hljs-variable">.totalLength</span>);
}
<span class="hljs-comment">// 3.请求完毕（成功\失败）</span>
- (<span class="hljs-keyword">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session task:(NSURLSessionTask *)task didCompleteWithError:(<span class="hljs-built_in">NSError</span> *)error
{
    <span class="hljs-comment">// 关闭流</span>
    [<span class="hljs-keyword">self</span><span class="hljs-variable">.stream</span> close];
    <span class="hljs-keyword">self</span><span class="hljs-variable">.stream</span> = <span class="hljs-literal">nil</span>;
    <span class="hljs-comment">// 清除任务</span>
    <span class="hljs-keyword">self</span><span class="hljs-variable">.task</span> = <span class="hljs-literal">nil</span>;
}
</code></pre>
<h2 id="afn">AFN</h2>
<ul>
<li>responseSerializer 用来解析服务器返回的数据<ul>
<li>[AFXMLParserResponseSerializer serializer] 告诉AFN，以XML形式解析服务器返回的数据</li>
<li>[AFJSONResponseSerializer serializer]; // 解析服务器返回的JSON数据</li>
<li>[AFHTTPResponseSerializer serializer]//直接使用“服务器本来返回的数据”，不做任何解析</li>
</ul>
</li>
<li>get</li>
</ul>
<pre><code class="lang-objc"><span class="hljs-comment">// AFHTTPSessionManager内部包装了NSURLSession</span>
AFHTTPSessionManager *mgr = [AFHTTPSessionManager manager];
<span class="hljs-built_in">NSDictionary</span> *params = @{
                             <span class="hljs-string">@"username"</span> : <span class="hljs-string">@"520it"</span>,
                             <span class="hljs-string">@"pwd"</span> : <span class="hljs-string">@"520it"</span>
                             };
[mgr GET:<span class="hljs-string">@"http://120.25.226.186:32812/login"</span> parameters:params success:^(<span class="hljs-built_in">NSURLSessionDataTask</span> *task, <span class="hljs-keyword">id</span> responseObject) {
        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"请求成功---%@"</span>, responseObject);
} failure:^(<span class="hljs-built_in">NSURLSessionDataTask</span> *task, <span class="hljs-built_in">NSError</span> *error) {
}];

AFHTTPRequestOperationManager *mgr = [AFHTTPRequestOperationManager manager];
<span class="hljs-built_in">NSDictionary</span> *params = @{
                             <span class="hljs-string">@"username"</span> : <span class="hljs-string">@"520it"</span>,
                             <span class="hljs-string">@"pwd"</span> : <span class="hljs-string">@"520it"</span>
                             };
[mgr GET:<span class="hljs-string">@"http://120.25.226.186:32812/login"</span> parameters:params
     success:^(AFHTTPRequestOperation *operation, <span class="hljs-keyword">id</span> responseObject) {
         <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"请求成功---%@"</span>, responseObject);
} failure:^(AFHTTPRequestOperation *operation, <span class="hljs-built_in">NSError</span> *error) {
}];
</code></pre>
<ul>
<li>post</li>
</ul>
<pre><code class="lang-objc">AFHTTPSessionManager *mgr = [AFHTTPSessionManager manager];
<span class="hljs-built_in">NSDictionary</span> *params = @{
                             <span class="hljs-string">@"username"</span> : <span class="hljs-string">@"520it"</span>,
                             <span class="hljs-string">@"pwd"</span> : <span class="hljs-string">@"520it"</span>
                             };
[mgr POST:<span class="hljs-string">@"http://120.25.226.186:32812/login"</span> parameters:params success:^(<span class="hljs-built_in">NSURLSessionDataTask</span> *task, <span class="hljs-keyword">id</span> responseObject) {
        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"请求成功---%@"</span>, responseObject);
} failure:^(<span class="hljs-built_in">NSURLSessionDataTask</span> *task, <span class="hljs-built_in">NSError</span> *error) {
}];

<span class="hljs-comment">// AFHTTPRequestOperationManager内部包装了NSURLConnection</span>
AFHTTPRequestOperationManager *mgr = [AFHTTPRequestOperationManager manager];
<span class="hljs-built_in">NSDictionary</span> *params = @{
                            <span class="hljs-string">@"username"</span> : <span class="hljs-string">@"520it"</span>,
                            <span class="hljs-string">@"pwd"</span> : <span class="hljs-string">@"520it"</span>
                        };
[mgr POST:<span class="hljs-string">@"http://120.25.226.186:32812/login"</span> parameters:params success:^(AFHTTPRequestOperation *operation, <span class="hljs-keyword">id</span> responseObject) {
         <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"请求成功---%@"</span>, responseObject);
} failure:^(AFHTTPRequestOperation *operation, <span class="hljs-built_in">NSError</span> *error) {
}];
</code></pre>
<ul>
<li>upload</li>
</ul>
<pre><code class="lang-objc">AFHTTPSessionManager *mgr = [AFHTTPSessionManager manager];
    [mgr POST:<span class="hljs-string">@"http://120.25.226.186:32812/upload"</span> parameters:@{<span class="hljs-string">@"username"</span> : <span class="hljs-string">@"123"</span>} constructingBodyWithBlock:^(<span class="hljs-keyword">id</span>&lt;AFMultipartFormData&gt; formData) {
        <span class="hljs-comment">// 在这个block中设置需要上传的文件</span>
        <span class="hljs-comment">/*NSData *data = [NSData dataWithContentsOfFile:@"/Users/LiJun/Downloads/banner_holdImage@2x.png"];
        [formData appendPartWithFileData:data name:@"file" fileName:@"test.png" mimeType:@"image/png"];*/</span>
        <span class="hljs-comment">/*[formData appendPartWithFileURL:[NSURL fileURLWithPath:@"/Users/LiJun/Downloads/banner_holdImage@2x.png"] name:@"file" fileName:@"xxx.png" mimeType:@"image/png" error:nil];*/</span>
        [formData appendPartWithFileURL:[<span class="hljs-built_in">NSURL</span> fileURLWithPath:<span class="hljs-string">@"/Users/LiJun/Downloads/banner_holdImage@2x.png"</span>] name:<span class="hljs-string">@"file"</span> error:<span class="hljs-literal">nil</span>];
    } success:^(<span class="hljs-built_in">NSURLSessionDataTask</span> *task, <span class="hljs-keyword">id</span> responseObject) {
       <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"-------%@"</span>, responseObject);
    } failure:^(<span class="hljs-built_in">NSURLSessionDataTask</span> *task, <span class="hljs-built_in">NSError</span> *error) {
    }];

    <span class="hljs-comment">// 1.获得请求管理者</span>
AFHTTPRequestOperationManager *mgr = [AFHTTPRequestOperationManager manager];
<span class="hljs-comment">// 2.发送请求(做文件上传)</span>
<span class="hljs-comment">// parameters : 只能放非文件参数</span>
<span class="hljs-built_in">NSMutableDictionary</span> *params = [<span class="hljs-built_in">NSMutableDictionary</span> dictionary];
params[<span class="hljs-string">@"username"</span>] = <span class="hljs-string">@"zhangsan"</span>;
[mgr POST:<span class="hljs-string">@"http://192.168.1.200:8080/MJServer/upload"</span> parameters:params
constructingBodyWithBlock:^(<span class="hljs-keyword">id</span>&lt;AFMultipartFormData&gt; formData) {
    <span class="hljs-comment">// 一定要在这个block中添加文件参数</span>
    <span class="hljs-comment">// 加载文件数据</span>
    <span class="hljs-built_in">NSString</span> *file = [[<span class="hljs-built_in">NSBundle</span> mainBundle] pathForResource:<span class="hljs-string">@"test.txt"</span> ofType:<span class="hljs-literal">nil</span>];
    <span class="hljs-built_in">NSData</span> *data = [<span class="hljs-built_in">NSData</span> dataWithContentsOfFile:file];
    <span class="hljs-comment">// 拼接文件参数</span>
    [formData appendPartWithFileData:data name:<span class="hljs-string">@"file"</span> fileName:<span class="hljs-string">@"123.txt"</span> mimeType:<span class="hljs-string">@"text/plain"</span>];
}
  success:^(AFHTTPRequestOperation *operation, <span class="hljs-keyword">id</span> responseObject) {
  } failure:^(AFHTTPRequestOperation *operation, <span class="hljs-built_in">NSError</span> *error) {
  }];
</code></pre>
<ul>
<li>网络状态监控
```objc
1.Reachability
//监听网络状态改变的通知
[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(networkStateChange) name:kReachabilityChangedNotification object:nil];
//创建Reachability
self.reachability = [Reachability reachabilityForInternetConnection];
//开始监控网络
[self.reachability startNotifier];
//处理网络状态改变</li>
<li><p>(void)networkStateChange
{
  // 1.检测wifi状态
  Reachability <em>wifi = [Reachability reachabilityForLocalWiFi];
  // 2.检测手机是否能上网络(WIFI\3G\2.5G)
  Reachability </em>conn = [Reachability reachabilityForInternetConnection];
  // 3.判断网络状态
  if ([wifi currentReachabilityStatus] != NotReachable) { // 有wifi</p>
<p>  } else if ([conn currentReachabilityStatus] != NotReachable) { // 没有使用wifi, 使用手机自带网络进行上网
  } else { // 没有网络
  }
}
2.AFN
AFNetworkReachabilityManager *mgr = [AFNetworkReachabilityManager sharedManager];
[mgr setReachabilityStatusChangeBlock:^(AFNetworkReachabilityStatus status) {
  switch (status) {</p>
<pre><code>  case AFNetworkReachabilityStatusUnknown :
      NSLog(@&quot;未知网络&quot;);
      break;
  case AFNetworkReachabilityStatusNotReachable :
      NSLog(@&quot;没有网络&quot;);
      break;
  case AFNetworkReachabilityStatusReachableViaWWAN :
      NSLog(@&quot;手机自带网络&quot;);
      break;
  case AFNetworkReachabilityStatusReachableViaWiFi :
      NSLog(@&quot;WIFI网络&quot;);
      break;
  default:
      break;
</code></pre><p>  }
}];
//开始监控
[mgr startMonitoring];
```</p>
<h2 id="md5">md5</h2>
</li>
<li><p>什么是MD5?
Message Digest Algorithm 5 译为“消息摘要算法第5版”
效果：对输入信息生成唯一的128位散列值(32个字符)
MD5的特点？
输入两个不同的明文不会得到相同的输出值
根据输出值，不能得到原始的明文，即其过程不可逆
MD5的应用
主要运用在数字签名、文件完整性验证以及口令加密
MD5加盐：
在明文的固定位置插入随机串，然后再进行MD5</p>
</li>
<li><p>如何保证数据安全？
用POST请求提交用户的隐私数据
提交用户的隐私数据时，不要明文提交，要加密处理后再提交
在本地不能保存用户的密码明文 使用iOS提供的钥匙串
常见的加密算法？
MD5\SHA\DES\3DES\RC2和RC4\RSA\IDEA\DSA\AES</p>
</li>
<li><p>js与objective-c交互
objective-c调用JavaScript语言，是通过 stringByEvaluatingJavaScriptFromString:方法实现，该方法向webview传递一段需要执行的JavaScript文件，最后获得执行结果。
JavaScript语言调用Objective-c语言，利用webView的特性，在UIWebview内发起的所有网络请求，都可以通过delegate函数在原生界面得到通知。我们在webview内发起一个特殊的网络请求，请求加载的网络地址内容不是真实的地址，地址常常类似这样： ios://methodname?argument 于是在webview的delegate函数中，我们只要发现是ios://开头的地址，就不进行内容的加载，转而执行相应的调用逻辑。在webview中发起一次特殊的网络请求，最合适的办法是创建一个临时隐藏的iFrame，在iFrame中加载这个特殊的网络请求。通过修改document.location也可以达到发起网络请求的效果。修改document.location有一个很严重的问题，就是如果我们连续两次修改document.location的话，在原生界面的delegate方法中，只能截获后面那次请求，前一次请求由于很快被替换掉，所以被忽略掉了。
window.location.href = ‘iOS://open&#39;;
如果不想自己实现具体的相互调用，可用开源的webviewJavaScriptBridge它能实现oc与JS相互调用功能</p>
</li>
<li><p>如何传递参数
NSInvocation : 利用一个NSInvocation对象包装一次方法调用（方法调用者、方法名、方法参数、方法返回值）
参数传递最简单的方式是将参数作为URL的一部分，如果传递很多参数可以用NSInvocation</p>
</li>
<li>我们还可以使用iOS7新增的关于JavaScriptCore相关的API，它可以用来获得一个JavaScript语言的执行环境</li>
<li>异常捕捉<ul>
<li>NSException</li>
<li>崩溃统计（第三方）<ul>
<li>友盟</li>
<li>Flurry</li>
<li>Crashlytics<pre><code class="lang-objc"><span class="hljs-comment">// 设置捕捉异常的回调</span>
NSSetUncaughtExceptionHandler(handleException);
<span class="hljs-keyword">void</span> handleException(<span class="hljs-built_in">NSException</span> *exception)
{
<span class="hljs-built_in">NSMutableDictionary</span> *info = [<span class="hljs-built_in">NSMutableDictionary</span> dictionary];
info[<span class="hljs-string">@"callStack"</span>] = [exception callStackSymbols]; <span class="hljs-comment">// 调用栈信息（错误来源于哪个方法）</span>
info[<span class="hljs-string">@"name"</span>] = [exception name]; <span class="hljs-comment">// 异常名字</span>
info[<span class="hljs-string">@"reason"</span>] = [exception reason]; <span class="hljs-comment">// 异常描述（报错理由）</span>
<span class="hljs-comment">//    [info writeToFile:&lt;#(NSString *)#&gt; atomically:&lt;#(BOOL)#&gt;];</span>
}
</code></pre>
</li>
</ul>
</li>
</ul>
</li>
</ul>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../thread/README.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Thread"><i class="fa fa-angle-left"></i></a>
        
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
