<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <title>Thread | Mou</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.0.3">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    
    <link rel="next" href="../network/README.html" />
    
    
    <link rel="prev" href="../cocoapods/README.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book"  data-level="28" data-basepath=".." data-revision="1462863912916">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         Markdown语法
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="base/README.html">
            
                
                    <a href="../base/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         base
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="uiview/README.html">
            
                
                    <a href="../uiview/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         UIView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="jiugongge/README.html">
            
                
                    <a href="../jiugongge/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         jiugongge
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4" data-path="uiscrollview/README.html">
            
                
                    <a href="../uiscrollview/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                         UIScrollView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5" data-path="uitableview/README.html">
            
                
                    <a href="../uitableview/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                         UITableView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="6" data-path="autolayout/README.html">
            
                
                    <a href="../autolayout/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                         autolayout
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="7" data-path="map/README.html">
            
                
                    <a href="../map/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                         map
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="8" data-path="notification/README.html">
            
                
                    <a href="../notification/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                         notification
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="9" data-path="nstimer/README.html">
            
                
                    <a href="../nstimer/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                         nstimer
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="10" data-path="oc/README.html">
            
                
                    <a href="../oc/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                         OC
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="11" data-path="rac/README.html">
            
                
                    <a href="../rac/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                         rac
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="12" data-path="review1/README.html">
            
                
                    <a href="../review1/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>12.</b>
                        
                         review1
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="13" data-path="review2/README.html">
            
                
                    <a href="../review2/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.</b>
                        
                         review2
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="14" data-path="audio/README.html">
            
                
                    <a href="../audio/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>14.</b>
                        
                         audio
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="15" data-path="twocode/README.html">
            
                
                    <a href="../twocode/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>15.</b>
                        
                         twocode
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="16" data-path="memory/README.html">
            
                
                    <a href="../memory/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>16.</b>
                        
                         memory
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="17" data-path="bluetooth/README.html">
            
                
                    <a href="../bluetooth/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>17.</b>
                        
                         bluetooth
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="18" data-path="touchid/README.html">
            
                
                    <a href="../touchid/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>18.</b>
                        
                         touchid
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="19" data-path="uiviewcontroller/README.html">
            
                
                    <a href="../uiviewcontroller/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>19.</b>
                        
                         UIViewController
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="20" data-path="delegate_kvo/README.html">
            
                
                    <a href="../delegate_kvo/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>20.</b>
                        
                         delegate kvo
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="21" data-path="datasave/README.html">
            
                
                    <a href="../datasave/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>21.</b>
                        
                         dataSave
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="22" data-path="pickerview/README.html">
            
                
                    <a href="../pickerview/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>22.</b>
                        
                         pickerView
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="23" data-path="quartz2d/README.html">
            
                
                    <a href="../quartz2d/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>23.</b>
                        
                         quartz2D
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="24" data-path="uitextfield/README.html">
            
                
                    <a href="../uitextfield/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>24.</b>
                        
                         UITextField
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="25" data-path="uidynamic/README.html">
            
                
                    <a href="../uidynamic/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>25.</b>
                        
                         UIDynamic
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="26" data-path="coreanimation/README.html">
            
                
                    <a href="../coreanimation/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>26.</b>
                        
                         coreAnimation
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="27" data-path="cocoapods/README.html">
            
                
                    <a href="../cocoapods/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>27.</b>
                        
                         Cocoapods
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="28" data-path="thread/README.html">
            
                
                    <a href="../thread/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>28.</b>
                        
                         Thread
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="29" data-path="network/README.html">
            
                
                    <a href="../network/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>29.</b>
                        
                         network
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >Mou</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_29">
                    
                        <h1 id="thread">Thread</h1>
<ul>
<li>什么是进程<ul>
<li>进程是指在系统中正在运行的一个应用程序，每个进程之间是独立的，每个进程均运行在其专用且受保护的内存空间内</li>
</ul>
</li>
<li>什么是线程<ul>
<li>1个进程要想执行任务，必须得有线程（每1个进程至少要有1条线程）</li>
<li>一个进程（程序）的所有任务都在线程中执行</li>
<li>1个线程中任务的执行是串行的</li>
</ul>
</li>
<li>多线程的原理<ul>
<li>同一时间，CPU只能处理1条线程，只有1条线程在工作
多线程并发（同时）执行，其实是CPU快速地在多条线程之间调度</li>
</ul>
</li>
<li>多线程的优点<ul>
<li>能适当提高程序的执行效率</li>
<li>能适当提高资源利用率（CPU、内存利用率）</li>
</ul>
</li>
<li>多线程的缺点<ul>
<li>创建线程是有开销的，iOS下主要成本包括：内核数据结构（大约1KB）、栈空间（子线程512KB、主线程1MB，也可以使用-setStackSize:设置，但必须是4K的倍数，而且最小是16K），创建线程大约需要90毫秒的创建时间
如果开启大量的线程，会降低程序的性能
线程越多，CPU在调度线程上的开销就越大
程序设计更加复杂：比如线程之间的通信、多线程的数据共享</li>
</ul>
</li>
</ul>
<h2 id="ios">iOS中多线程的实现方案</h2>
<ul>
<li>pthread(程序员管理线程生命周期，几乎不用) /NSThread(需要手动创建)/GCD/NSOperation</li>
<li>pthread</li>
</ul>
<pre><code class="lang-objc"><span class="hljs-preprocessor">#import <span class="hljs-title">&lt;pthread.h&gt;</span></span>
pthread_t thread;
pthread_create(&amp;thread, <span class="hljs-literal">NULL</span>, run, <span class="hljs-literal">NULL</span>);
<span class="hljs-keyword">void</span> * run(<span class="hljs-keyword">void</span> *param)
{
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSInteger</span> i = <span class="hljs-number">0</span>; i&lt;<span class="hljs-number">50000</span>; i++) {
        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"------buttonClick---%zd--%@"</span>, i, [<span class="hljs-built_in">NSThread</span> currentThread]);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}
</code></pre>
<ul>
<li>NSThread</li>
</ul>
<pre><code class="lang-objc"><span class="hljs-number">1.</span>开线程的三种方式
* 先创建,后启动
<span class="hljs-built_in">NSThread</span> *thread = [[<span class="hljs-built_in">NSThread</span> alloc] initWithTarget:<span class="hljs-keyword">self</span> selector:<span class="hljs-keyword">@selector</span>(run) object:<span class="hljs-literal">nil</span>];
[thread start];
*直接启动这<span class="hljs-number">2</span>种创建线程方式的优缺点
 优点:简单快捷
 缺点:无法对线程进行更详细的设置
[<span class="hljs-built_in">NSThread</span> detachNewThreadSelector:<span class="hljs-keyword">@selector</span>(run) toTarget:<span class="hljs-keyword">self</span> withObject:<span class="hljs-literal">nil</span>];
[<span class="hljs-keyword">self</span> performSelectorInBackground:<span class="hljs-keyword">@selector</span>(run) withObject:<span class="hljs-literal">nil</span>];

<span class="hljs-number">2.</span>其他用法
线程五种状态：新建-就绪-运行-阻塞-死亡
<span class="hljs-comment">// 获得当前线程</span>
 <span class="hljs-built_in">NSThread</span> *current = [<span class="hljs-built_in">NSThread</span> currentThread];
+ (<span class="hljs-built_in">NSThread</span> *)mainThread; <span class="hljs-comment">// 获得主线程</span>
<span class="hljs-comment">//睡到指定时间</span>
[<span class="hljs-built_in">NSThread</span> sleepUntilDate:[<span class="hljs-built_in">NSDate</span> dateWithTimeIntervalSinceNow:<span class="hljs-number">5.0</span>]];
<span class="hljs-comment">//休眠3秒(阻塞3秒)</span>
[<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">3.0</span>];
强制停止线程
+ (<span class="hljs-keyword">void</span>)exit;
<span class="hljs-number">3.</span>线程间通信
在<span class="hljs-number">1</span>个进程中，线程往往不是孤立存在的，多个线程之间需要经常进行通信
线程间通信的体现
 - <span class="hljs-number">1</span>个线程传递数据给另<span class="hljs-number">1</span>个线程
 - 在<span class="hljs-number">1</span>个线程中执行完特定任务后，转到另<span class="hljs-number">1</span>个线程继续执行任务
常用方法
performSelectorOnMainThread.....
performSelector: onThread
[<span class="hljs-keyword">self</span> performSelectorOnMainThread:<span class="hljs-keyword">@selector</span>(download) withObject:<span class="hljs-literal">nil</span> waitUntilDone:<span class="hljs-literal">YES</span>];
waitUntilDone表示是否等待<span class="hljs-keyword">@selector</span>方法执行完, 如果是<span class="hljs-literal">YES</span>就等待download方法执行结束，再往下执行
</code></pre>
<ul>
<li>GCD</li>
<li><p>Grand Central Dispatch 在MacOs X10.6中首次推出，并随后被引入到iOS4.0中)有2个核心概念： 任务(执行什么操作) 队列(用来存放任务)</p>
<ul>
<li>GCD使用就2个步骤<ul>
<li>定制任务(确定想做的事情)</li>
<li>将任务添加到队列中<ul>
<li>GCD会自动将队列中的任务取出放到对应的线程中执行,任务的取出遵循队列的FIFO原则，先进先出</li>
</ul>
</li>
</ul>
</li>
<li>GCD的队列可以分为2大类型<ul>
<li>并发队列(GCD默认已经提供了全局的并发队列,供整个应用使用，无需手动创建）
并发队列：可以同时(并发)执行多个任务(并发功能只有在异步(dispatch_async)函数下才有效)</li>
<li>串行队列[让任务一个接着一个地执行(一个任务执行完毕后，再执行下一个任务)]</li>
</ul>
</li>
<li><p>并发和串行决定了任务的执行方式</p>
</li>
<li><p>GCD2个用来执行任务的常用函数</p>
<ul>
<li>同步执行
dispatch_sync(dispatch_queue_t queue,dispatch_block_t block)queue:队列 block:任务</li>
<li>异步执行
dispatch_async(dispatch_queue_t queue, dispatch_block_t block);</li>
</ul>
</li>
<li>同步和异步决定了要不要开启新的线程<ul>
<li>同步和异步区别<ul>
<li>同步：只能在当前线程中执行，不具备开辟新线程的能力</li>
<li>异步：可以在新的线程中执行任务，具备开启新线程的能力</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code class="lang-objc"><span class="hljs-number">1.</span>并发队列创建方式
a.自己创建
<span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="hljs-string">"com.queu"</span>,DISPATCH_QUEUE_CONCURRENT);
b.全局的并发队列
获得全局的并发队列: dispatch_get_global_queue
第一个参数dispatch_queue_priority_t priority 队列优先级
第二个参数<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> flags 此参数暂时无用 用<span class="hljs-number">0</span>即可
<span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue( DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>);
全局并发队列的优先级
<span class="hljs-preprocessor">#define DISPATCH_QUEUE_PRIORITY_HIGH 2 高</span>
<span class="hljs-preprocessor">#define DISPATCH_QUEUE_PRIORITY_DEFAULT 0  中</span>
<span class="hljs-preprocessor">#define DISPATCH_QUEUE_PRIORITY_LOW (-2)  低</span>
<span class="hljs-preprocessor">#define DISPATCH_QUEUE_PRIORITY_BACKGROUND INT16_MIN 后台 最低</span>

<span class="hljs-number">2.</span>串行队列创建方式
a.自己创建
<span class="hljs-comment">//创建串行队列(队列类型传递NULL或DISPATCH_QUEUE_SERIAL)</span>
<span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="hljs-string">"com.itheima.queue"</span>, DISPATCH_QUEUE_SERIAL);
b.主队列(跟主线程相关联的队列)
<span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_get_main_queue();
放在主队列中的任务，都会放到主线程中执行
主队列是GCD自带的一种特殊的串行队列

<span class="hljs-number">3.</span>线程间通信
<span class="hljs-built_in">dispatch_async</span>(
dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^{
   <span class="hljs-comment">// 执行耗时的异步操作...</span>
   <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^{
       <span class="hljs-comment">// 回到主线程，执行UI刷新操作</span>
   });
});

<span class="hljs-number">4.</span>其他用法
@dispatch_barrier_async
GCD中用来执行任务的函数:
dispatch_barrier_async(<span class="hljs-built_in">dispatch_queue_t</span> queue, dispatch_block_t block);
它会等到在它加入队列之前的block执行完毕后，才开始执行。在它之后加入队列的block，则等到这个block执行完毕后才开始执行。
这里指定的并发队列应该是自己通过dispatch_queue_create函数创建的。如果你传的是一个串行队列或者全局并发队列，这个函数等同于<span class="hljs-built_in">dispatch_async</span>函数。
<span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="hljs-string">"com.itheima.queue"</span>, DISPATCH_QUEUE_SERIAL);
<span class="hljs-built_in">dispatch_async</span>(queue, ^{
   <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"-----1-----%@"</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);
});
dispatch_barrier_async(queue, ^{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"-----barrier-----%@"</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);
});
<span class="hljs-built_in">dispatch_async</span>(queue, ^{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"-----3-----%@"</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);
});

@dispatch_once  函数能保证某段代码在程序运行过程中只被执行<span class="hljs-number">1</span>次
<span class="hljs-keyword">static</span> <span class="hljs-built_in">dispatch_once_t</span> onceToken;
<span class="hljs-built_in">dispatch_once</span>(&amp;onceToken, ^{
    <span class="hljs-comment">// 只执行1次的代码(这里面默认是线程安全的)</span>
});

@dispatch_source 定时器
<span class="hljs-comment">// 获得队列</span>
<span class="hljs-comment">//dispatch_queue_t queue = dispatch_get_global_queue(0, 0);</span>
<span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_get_main_queue();
<span class="hljs-comment">// 创建一个定时器(dispatch_source_t本质还是个OC对象)</span>
<span class="hljs-keyword">self</span><span class="hljs-variable">.timer</span> = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, queue);
<span class="hljs-comment">// 设置定时器的各种属性（几时开始任务，每隔多长时间执行一次）</span>
<span class="hljs-comment">// GCD的时间参数，一般是纳秒（1秒 == 10的9次方纳秒）</span>
<span class="hljs-comment">// 何时开始执行第一个任务</span>
<span class="hljs-comment">// dispatch_time(DISPATCH_TIME_NOW, 1.0 * NSEC_PER_SEC) 比当前时间晚3秒</span>
dispatch_time_t start = dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="hljs-number">1.0</span> * NSEC_PER_SEC));
<span class="hljs-comment">//时间间隔</span>
uint64_t interval = (uint64_t)(<span class="hljs-number">1.0</span> * NSEC_PER_SEC);
dispatch_source_set_timer(<span class="hljs-keyword">self</span><span class="hljs-variable">.timer</span>, start, interval, <span class="hljs-number">0</span>);
<span class="hljs-comment">// 设置回调</span>
dispatch_source_set_event_handler(<span class="hljs-keyword">self</span><span class="hljs-variable">.timer</span>, ^{
    count++;
    <span class="hljs-keyword">if</span> (count == <span class="hljs-number">4</span>) {
        <span class="hljs-comment">// 取消定时器</span>
        dispatch_cancel(<span class="hljs-keyword">self</span><span class="hljs-variable">.timer</span>);
        <span class="hljs-keyword">self</span><span class="hljs-variable">.timer</span> = <span class="hljs-literal">nil</span>;
    }
});
<span class="hljs-comment">// 启动定时器</span>
dispatch_resume(<span class="hljs-keyword">self</span><span class="hljs-variable">.timer</span>);

@dispatch_apply 函数能进行快速迭代遍历
用串行队列是按顺序一个个遍历，用并发队列是同时遍历
<span class="hljs-comment">//dispatch_queue_t queue = dispatch_queue_create("com.iteh", DISPATCH_QUEUE_SERIAL);</span>
<span class="hljs-comment">//dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</span>
<span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="hljs-string">"com.ite"</span>, DISPATCH_QUEUE_CONCURRENT);
<span class="hljs-built_in">NSString</span> *from = <span class="hljs-string">@"/Users/LiJun/Desktop/From"</span>;
<span class="hljs-built_in">NSString</span> *to = <span class="hljs-string">@"/Users/LiJun/Desktop/To"</span>;
<span class="hljs-built_in">NSFileManager</span> *mgr = [<span class="hljs-built_in">NSFileManager</span> defaultManager];
<span class="hljs-built_in">NSArray</span> *subpaths = [mgr subpathsAtPath:from];
dispatch_apply(subpaths<span class="hljs-variable">.count</span>, queue, ^(size_t index) {
    <span class="hljs-built_in">NSString</span> *subpath = subpaths[index];
    <span class="hljs-built_in">NSString</span> *fromFullPath = [from stringByAppendingPathComponent:subpath];
    <span class="hljs-built_in">NSString</span> *toFullPath = [to stringByAppendingPathComponent:subpath];
    [mgr moveItemAtPath:fromFullPath toPath:toFullPath error:<span class="hljs-literal">nil</span>];
});

@dispatch_group_async\dispatch_group_notify（能让多个任务同时执行，等多个任务都执行完再回到主线程）
<span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>);
dispatch_group_t group = dispatch_group_create();
dispatch_group_async(group, queue, ^{
    <span class="hljs-built_in">NSURL</span> *url = [<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@"http://g.hiphotos.baidu.com/image/pic/item/241f95cad1c8a7866f726fe06309c93d71cf5087.jpg"</span>];
    <span class="hljs-built_in">NSData</span> *data = [<span class="hljs-built_in">NSData</span> dataWithContentsOfURL:url];
    _image1 = [<span class="hljs-built_in">UIImage</span> imageWithData:data];
});
<span class="hljs-comment">//下载图2</span>
dispatch_group_async(group, queue, ^{
 <span class="hljs-built_in">NSURL</span> *url = [<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@"http://e.hiphotos.baidu.com/image/h%3D360/sign=eec961354890f6031bb09a410912b370/472309f7905298221645d4c7d5ca7bcb0a46d444.jpg"</span>];
 <span class="hljs-built_in">NSData</span> *data = [<span class="hljs-built_in">NSData</span> dataWithContentsOfURL:url];
 _image2 = [<span class="hljs-built_in">UIImage</span> imageWithData:data];
});
dispatch_group_notify(group, queue, ^{
 <span class="hljs-comment">//将图1图2合成新图片</span>
 UIGraphicsBeginImageContextWithOptions(CGSizeMake(<span class="hljs-number">356</span>, <span class="hljs-number">438</span>), <span class="hljs-literal">NO</span>, <span class="hljs-number">0</span>);
 [_image1 drawInRect:CGRectMake(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">128</span>, <span class="hljs-number">219</span>)];
 [_image2 drawInRect:CGRectMake(<span class="hljs-number">128</span>, <span class="hljs-number">0</span>, <span class="hljs-number">128</span>, <span class="hljs-number">219</span>)];
 <span class="hljs-built_in">UIImage</span> *image = UIGraphicsGetImageFromCurrentImageContext();
 UIGraphicsEndImageContext();
 <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^{
   <span class="hljs-keyword">self</span><span class="hljs-variable">.imgView</span><span class="hljs-variable">.image</span> = image;
 });
});

iOS常见的延时执行函数
*调用<span class="hljs-built_in">NSObject</span>的方法
[<span class="hljs-keyword">self</span> performSelector:<span class="hljs-keyword">@selector</span>(run) withObject:<span class="hljs-literal">nil</span> afterDelay:<span class="hljs-number">2.0</span>];
<span class="hljs-comment">// 2秒后再调用self的run方法</span>
*使用GCD函数 dispatch_after 延时执行函数
dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="hljs-number">2.0</span> * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
    <span class="hljs-comment">// 2秒后异步执行这里的代码...</span>
});
*使用NSTimer
[NSTimer scheduledTimerWithTimeInterval:<span class="hljs-number">2.0</span> target:<span class="hljs-keyword">self</span> selector:<span class="hljs-keyword">@selector</span>(test) userInfo:<span class="hljs-literal">nil</span> repeats:<span class="hljs-literal">NO</span>];

同步函数+串行队列
<span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="hljs-string">"com.520it"</span>, DISPATCH_QUEUE_SERIAL);
    <span class="hljs-built_in">dispatch_sync</span>(queue, ^{
        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"1-------%@"</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);
        <span class="hljs-built_in">dispatch_sync</span>(queue, ^{
            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"4-------%@"</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);
        });
    });
执行完<span class="hljs-number">1</span>卡住
</code></pre>
<ul>
<li><p>NSOperation</p>
<ul>
<li><p>基本使用 NSOperation是个抽象类，必须使用它的子类，其子类化有三种方式</p>
<ul>
<li>NSInvocationOperation</li>
<li>NSBlockOperation<ul>
<li>只要NSBlockOperation封装的操作数&gt;1,就会异步执行操作</li>
</ul>
</li>
<li>自定义子类继承NSOperation, 实现内部方法</li>
</ul>
</li>
<li><p>NSOperationQueue的队列类型</p>
<ul>
<li>主队列<ul>
<li>[NSOperationQueue mainQueue]</li>
<li>凡是添加到主队列中的任务（NSOperation），都会放到主线程中执行</li>
</ul>
</li>
<li>非主队列（其他队列）<ul>
<li>[[NSOperationQueue alloc] init]</li>
<li>同时包含了：串行、并发功能</li>
<li>添加到这种队列中的任务（NSOperation），就会自动放到子线程中执行</li>
</ul>
</li>
</ul>
</li>
<li><p>最大并发数设置</p>
<ul>
<li>NSOperationQueue是并发还是串行由最大并发数决定，最大并发数等于1就是串行队列，大于1就是并发队列 (最大并发数，不是线程的数量，而是同时执行的操作数量)
//设置最大的并发数是2，
self.opQueue.maxConcurrentOperationCount = 2;</li>
</ul>
</li>
<li><p>设置依赖
[operationB addDependency:operationA]; // 操作B依赖于操作A
//waitUntilFinished YES 等待上面的操作执行结束 NO不等待
[self.opQueue addOperations:@[op1,op2,op3] waitUntilFinished:YES];</p>
</li>
</ul>
</li>
<li>监听一个操作的执行完毕</li>
<li>(void (^)(void))completionBlock;</li>
<li><p>(void)setCompletionBlock:(void (^)(void))block;</p>
</li>
<li><p>只要是NSOperation的子类，就能添加到操作队列一旦操作添加到队列，就会自动异步执行(会自动调用operation的start方法，start方法会调用内部的main方法)如果没有添加到队列，而是使用start方法，会在当前线程执行操作</p>
</li>
<li>如果要做线程间通信，可以使用[NSOperationQueue mainQueue]拿到主队列，往主队列添加操作</li>
<li>暂停/继续 (队列的暂停和继续)<ul>
<li>self.opQueue.suspended = !self.opQueue.suspended;</li>
</ul>
</li>
<li><p>取消队列的所有操作</p>
<ul>
<li>[self.opQueue cancelAllOperations];</li>
</ul>
</li>
<li><p>自定义Operation(了解基本流程)</p>
<ul>
<li>自定义子类继承NSOperation</li>
<li>重写 main方法，在里面实现想执行的任务</li>
<li>重写main方法需要注意</li>
<li>自己创建自动释放池</li>
<li>经常通过isCancelled方法检测操作是否被取消，对取消做出响应</li>
</ul>
</li>
<li><p>如何解决一张图片(一个url)重复下载的问题</p>
<ul>
<li>定义一个字典缓存所有操作，以图片url为key，下载操作为value, 如果这个下载操作为空，就创建一个下载操作然后把这个操作加到队列中，同时存放到字典中</li>
</ul>
</li>
<li><p>SDWebImage下载图片原理</p>
<ul>
<li>先根据图片的url去图片缓存中取图片，如果没有就检查沙盒中存不存在对应的图片，如果沙盒中有就取出来直接显示同时把将图片放到内存缓存中，如果沙盒中也没有就先显示占位图片根据图片的url查看操作缓存中存不存在下载操作，如果不存在就创建下载操作异步下载图片并把下载操作放到操作缓存中，下载完了将操作从操作缓存中移除将图片放到内存缓存中，同时将图片存入沙盒</li>
</ul>
</li>
</ul>
<pre><code class="lang-objc">NSInvocationOperation *op = [[NSInvocationOperation alloc] initWithTarget:<span class="hljs-keyword">self</span> selector:<span class="hljs-keyword">@selector</span>(run) object:<span class="hljs-literal">nil</span>];
[op start];
NSBlockOperation *op = [NSBlockOperation blockOperationWithBlock:^{
    <span class="hljs-comment">// 在主线程</span>
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"下载1------%@"</span>, [<span class="hljs-built_in">NSThread</span> currentThread]);
}];
<span class="hljs-comment">// 添加额外的任务(在子线程执行)</span>
[op addExecutionBlock:^{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"下载2------%@"</span>, [<span class="hljs-built_in">NSThread</span> currentThread]);
}];
[op start];

NSOperationQueue
<span class="hljs-comment">// 创建队列</span>
NSOperationQueue *queue = [[NSOperationQueue alloc] init];
<span class="hljs-comment">// 创建操作（任务）</span>
<span class="hljs-comment">// 创建NSInvocationOperation</span>
NSInvocationOperation *op1 = [[NSInvocationOperation alloc] initWithTarget:<span class="hljs-keyword">self</span> selector:<span class="hljs-keyword">@selector</span>(download1) object:<span class="hljs-literal">nil</span>];
<span class="hljs-comment">// 创建NSBlockOperation</span>
NSBlockOperation *op3 = [NSBlockOperation blockOperationWithBlock:^{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"download3 --- %@"</span>, [<span class="hljs-built_in">NSThread</span> currentThread]);
}];
[op3 addExecutionBlock:^{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"download4 --- %@"</span>, [<span class="hljs-built_in">NSThread</span> currentThread]);
}];
<span class="hljs-comment">// 添加任务到队列中</span>
[queue addOperation:op1]; 该操作里面默认执行[op1 start]
[queue addOperation:op3];
添加任务到队列还有一种写法
[queue addOperationWithBlock:^{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"download2 --- %@"</span>, [<span class="hljs-built_in">NSThread</span> currentThread]);
}];

最大并发数
<span class="hljs-comment">// 创建队列</span>
NSOperationQueue *queue = [[NSOperationQueue alloc] init];
 <span class="hljs-comment">// 设置最大并发操作数</span>
queue<span class="hljs-variable">.maxConcurrentOperationCount</span> = <span class="hljs-number">1</span>; <span class="hljs-comment">// 就变成了串行队列 大于1为并发队列</span>
<span class="hljs-comment">// 添加操作</span>
[queue addOperationWithBlock:^{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"download1 --- %@"</span>, [<span class="hljs-built_in">NSThread</span> currentThread]);
    [<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">0.01</span>];
}];
[queue addOperationWithBlock:^{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"download2 --- %@"</span>, [<span class="hljs-built_in">NSThread</span> currentThread]);
    [<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">0.01</span>];
}];
设置依赖 实现图片合并
NSOperationQueue *queue = [[NSOperationQueue alloc] init];
NSBlockOperation *op1 = [NSBlockOperation blockOperationWithBlock:^{
    <span class="hljs-built_in">NSURL</span> *url = [<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@"http://g.hiphotos.baidu.com/image/pic/item/241f95cad1c8a7866f726fe06309c93d71cf5087.jpg"</span>];
    <span class="hljs-built_in">NSData</span> *data = [<span class="hljs-built_in">NSData</span> dataWithContentsOfURL:url];
    _image1 = [<span class="hljs-built_in">UIImage</span> imageWithData:data];
}];
NSBlockOperation *op2 = [NSBlockOperation blockOperationWithBlock:^{
    <span class="hljs-built_in">NSURL</span> *url = [<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@"http://e.hiphotos.baidu.com/image/h%3D360/sign=eec961354890f6031bb09a410912b370/472309f7905298221645d4c7d5ca7bcb0a46d444.jpg"</span>];
    <span class="hljs-built_in">NSData</span> *data = [<span class="hljs-built_in">NSData</span> dataWithContentsOfURL:url];
    _image2 = [<span class="hljs-built_in">UIImage</span> imageWithData:data];
}];
NSBlockOperation *op3 = [NSBlockOperation blockOperationWithBlock:^{
    <span class="hljs-comment">//将图1图2合成新图片</span>
    UIGraphicsBeginImageContextWithOptions(CGSizeMake(<span class="hljs-number">356</span>, <span class="hljs-number">438</span>), <span class="hljs-literal">NO</span>, <span class="hljs-number">0</span>);
    [_image1 drawInRect:CGRectMake(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">128</span>, <span class="hljs-number">219</span>)];
    [_image2 drawInRect:CGRectMake(<span class="hljs-number">128</span>, <span class="hljs-number">0</span>, <span class="hljs-number">128</span>, <span class="hljs-number">219</span>)];
    <span class="hljs-built_in">UIImage</span> *image = UIGraphicsGetImageFromCurrentImageContext();
    UIGraphicsEndImageContext();

    [[NSOperationQueue mainQueue] addOperationWithBlock:^{
             <span class="hljs-keyword">self</span><span class="hljs-variable">.imgView</span><span class="hljs-variable">.image</span> = image;
    }];
}];
[op3 addDependency:op1];
[op3 addDependency:op2];
[queue addOperation:op1];
[queue addOperation:op2];
[queue addOperation:op3];
</code></pre>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../cocoapods/README.html" class="navigation navigation-prev " aria-label="Previous page: Cocoapods"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../network/README.html" class="navigation navigation-next " aria-label="Next page: network"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
